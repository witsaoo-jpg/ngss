<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• v40.3 - Workday Target</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "xlsx": "https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background-color: #f8fafc; }
        .overflow-x-auto::-webkit-scrollbar { height: 12px; }
        .overflow-x-auto::-webkit-scrollbar-track { background: #f1f5f9; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; border: 2px solid #f1f5f9; }
        table { border-spacing: 0; width: 100%; border-collapse: separate; }
        th, td { white-space: nowrap; text-align: center; border: 1px solid #e2e8f0; height: 32px; padding: 0 4px; font-size: 13px; box-sizing: border-box; }
        .sticky-1 { position: sticky; left: 0; width: 40px; min-width: 40px; background-color: white; z-index: 35; border-right: 1px solid #e2e8f0; }
        .sticky-2 { position: sticky; left: 40px; width: 160px; min-width: 160px; background-color: white; z-index: 35; border-right: 1px solid #e2e8f0; }
        .sticky-3 { position: sticky; left: 200px; width: 70px; min-width: 70px; background-color: white; border-right: 3px solid #cbd5e1; box-shadow: 4px 0 6px -2px rgba(0, 0, 0, 0.1); z-index: 35; }
        thead tr th { position: sticky; top: 0; z-index: 40; background-color: #f1f5f9; color: #334155; height: 50px; }
        thead tr th.sticky-1, thead tr th.sticky-2, thead tr th.sticky-3 { z-index: 50; background-color: #f8fafc; }
        .cell-hover:hover { filter: brightness(0.95); cursor: pointer; transform: scale(1.1); transition: transform 0.1s; z-index: 10; position: relative; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @media print { .no-print { display: none !important; } table { font-size: 10px; width: 100%; } th, td { height: 20px; padding: 0; border: 1px solid #000; } .sticky-1, .sticky-2, .sticky-3 { position: static; border-right: 1px solid #000; box-shadow: none; width: auto; min-width: auto; } body { background-color: white; } .overflow-x-auto { overflow: visible; } }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Download, Calculator, UserPlus, Trash2, ChevronLeft, ChevronRight, Zap, Eraser, Settings, Edit2, Save, X, Plus, Sliders } from 'lucide-react';
        import * as XLSX from 'xlsx';

        // --- CONFIG ---
        const DEFAULT_SHIFTS = [
            { id: 'm', label: '‡∏ä', name: '‡πÄ‡∏ä‡πâ‡∏≤', color: 'bg-green-100 text-green-800', price: 0, required: 6, isNight: false }, 
            { id: 'a', label: '‡∏ö', name: '‡∏ö‡πà‡∏≤‡∏¢', color: 'bg-yellow-100 text-yellow-800', price: 360, required: 4, isNight: false },
            { id: 'n', label: '‡∏î', name: '‡∏î‡∏∂‡∏Å', color: 'bg-purple-100 text-purple-800', price: 360, required: 2, isNight: true }
        ];

        const DEFAULT_RULES = {
            noNightToMorning: true,     
            noConsecutiveDoubles: false, 
            equalDistribution: true,    
            strictWorkLimit: false,     
        };

        const OT_RATE_DEFAULT = 800;
        const NON_WORKING_CODES = ['Va', '‡∏õ‡∏ä', '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', '‡∏•‡∏≤‡∏Å‡∏¥‡∏à'];
        const LEAVE_TYPES = {
            'Va': { label: 'Va', color: 'bg-blue-100 text-blue-800 font-bold text-xs' },
            '‡∏õ‡∏ä': { label: '‡∏õ‡∏ä', color: 'bg-orange-100 text-orange-800 font-bold text-xs' },
            '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢': { label: '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', color: 'bg-red-100 text-red-800 font-bold text-[10px]' },
            '‡∏•‡∏≤‡∏Å‡∏¥‡∏à': { label: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à', color: 'bg-indigo-100 text-indigo-800 font-bold text-[10px]' }
        };

        const INITIAL_NURSES = [
            { id: 1, name: "‡∏ô‡∏≤‡∏á‡∏™‡∏á‡∏ö ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏ò‡∏£‡∏£‡∏°", pos: "‡∏´‡∏ô‡∏ï." },
            { id: 2, name: "‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏©‡∏ì‡∏∏‡∏Å‡∏£‡∏ì‡πå ‡πÇ‡∏¢‡∏¢‡∏≤", pos: "L5" },
            { id: 3, name: "‡∏ô.‡∏™.‡∏à‡∏≤‡∏£‡∏∏‡∏û‡∏£ ‡∏®‡∏£‡∏µ‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥", pos: "L5" },
            { id: 4, name: "‡∏ô.‡∏™.‡πÄ‡∏Ç‡∏°‡∏£‡∏∏‡∏à‡∏¥ ‡∏¢‡∏≤‡∏™‡∏π‡πà", pos: "L4" },
            { id: 5, name: "‡∏ô.‡∏™.‡∏õ‡∏≤‡∏à‡∏≤‡∏£‡∏µ‡∏¢‡πå ‡∏ô‡∏¥‡∏û‡∏±‡∏ô‡∏ò‡πå", pos: "L4" },
            { id: 6, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏ô‡∏¥‡∏™‡∏≤ ‡∏™‡∏∏‡∏Ç‡πÄ‡∏≠‡∏¥‡∏ö", pos: "L4" },
            { id: 7, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏†‡∏≤‡∏ß‡∏î‡∏µ ‡∏¢‡∏°‡∏ô‡πâ‡∏≠‡∏¢", pos: "L2" },
            { id: 8, name: "‡∏ô.‡∏™.‡∏ó‡∏¥‡∏û‡∏õ‡∏†‡∏≤ ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏ò‡∏µ", pos: "L2" },
            { id: 9, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏ô‡∏±‡∏ô‡∏ó‡∏£‡∏≤ ‡πÄ‡∏Å‡∏ï‡∏∏‡∏û‡∏á‡∏©‡πå", pos: "L1" },
            { id: 10, name: "‡∏ô.‡∏™.‡∏™‡∏¥‡∏£‡∏¥‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏ö‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê", pos: "L1" }
        ];

        const getRandomColorClass = () => {
            const colors = ['bg-pink-100 text-pink-800', 'bg-indigo-100 text-indigo-800', 'bg-teal-100 text-teal-800', 'bg-orange-100 text-orange-800'];
            return colors[Math.floor(Math.random() * colors.length)];
        };

        export default function RosterApp() {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [nurses, setNurses] = useState(INITIAL_NURSES);
            const [schedule, setSchedule] = useState({});
            const [customHolidays, setCustomHolidays] = useState([]);
            const [workDayLimit, setWorkDayLimit] = useState(19); // Default to 19 to match screenshot example
            
            const [shiftConfig, setShiftConfig] = useState(DEFAULT_SHIFTS);
            const [rulesConfig, setRulesConfig] = useState(DEFAULT_RULES);
            const [otRate, setOtRate] = useState(OT_RATE_DEFAULT);

            const [showModal, setShowModal] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [newNurse, setNewNurse] = useState({ name: '', pos: 'L1' });
            const [editingNurse, setEditingNurse] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);

            useEffect(() => {
                const loadData = () => {
                    const data = localStorage.getItem('roster_data_v40_force');
                    if (data) {
                        const parsed = JSON.parse(data);
                        setSchedule(parsed.schedule || {});
                        setNurses(parsed.nurses || INITIAL_NURSES);
                        setCustomHolidays(parsed.holidays || []);
                        setWorkDayLimit(parsed.limit || 19);
                        if (parsed.shiftConfig) setShiftConfig(parsed.shiftConfig);
                        if (parsed.rulesConfig) setRulesConfig(parsed.rulesConfig);
                        if (parsed.otRate) setOtRate(parsed.otRate);
                    }
                };
                loadData();
            }, []);

            const saveData = (overrides = {}) => {
                const dataToSave = {
                    schedule, nurses, holidays: customHolidays, limit: workDayLimit,
                    shiftConfig, rulesConfig, otRate,
                    ...overrides
                };
                if (overrides.schedule) setSchedule(overrides.schedule);
                if (overrides.nurses) setNurses(overrides.nurses);
                if (overrides.holidays) setCustomHolidays(overrides.holidays);
                if (overrides.limit) setWorkDayLimit(overrides.limit);
                if (overrides.shiftConfig) setShiftConfig(overrides.shiftConfig);
                if (overrides.rulesConfig) setRulesConfig(overrides.rulesConfig);
                if (overrides.otRate) setOtRate(overrides.otRate);
                localStorage.setItem('roster_data_v40_force', JSON.stringify(dataToSave));
            };

            const getDaysInMonth = () => new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const getKey = (id, row, day) => `${id}-${row}-${day}`;
            const isHN = (n) => n.pos && n.pos.includes('‡∏´‡∏ô‡∏ï');
            const isHoliday = (day) => {
                const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                return [0, 6].includes(d.getDay()) || customHolidays.includes(day);
            };

            const getShiftStyle = (val) => {
                const shift = shiftConfig.find(s => s.label === val);
                if (shift) return { label: shift.label, color: `${shift.color} font-bold` };
                if (LEAVE_TYPES[val]) return LEAVE_TYPES[val];
                return { label: val, color: 'text-gray-300' };
            };

            const countStats = (nurseId) => {
                const days = getDaysInMonth();
                let otCount = 0;
                let workDays = 0;
                let shiftPay = 0;
                let bdCount = 0;

                for(let d=1; d<=days; d++) {
                    const valTop = schedule[getKey(nurseId, 0, d)] || '0';
                    const valBot = schedule[getKey(nurseId, 1, d)] || '0';
                    
                    const otShift = shiftConfig.find(s => s.label === valTop);
                    if (otShift) otCount++;

                    const normShift = shiftConfig.find(s => s.label === valBot);
                    if (normShift) {
                        workDays++;
                        shiftPay += normShift.price;
                        if (normShift.price > 0) bdCount++;
                    }
                }
                return { otCount, otPay: otCount * otRate, bdCount, shiftPay, workDays };
            };

            const countDailyTotal = (day, label, scheduleToUse = schedule) => {
                let count = 0;
                nurses.forEach(n => {
                    if(scheduleToUse[getKey(n.id, 0, day)] === label) count++;
                    if(scheduleToUse[getKey(n.id, 1, day)] === label) count++;
                });
                return count;
            };

            // --- CORE LOGIC: FORCE FILL ---
            const autoGenerateRoster = async () => {
                const totalTarget = shiftConfig.reduce((sum, s) => sum + s.required, 0);
                const totalCapacity = nurses.length;
                
                let confirmMsg = `üéØ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£ (v40.3)?\n\n` +
                                 `‚Ä¢ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${totalTarget} ‡πÄ‡∏ß‡∏£/‡∏ß‡∏±‡∏ô\n` +
                                 `‚Ä¢ ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ: ${totalCapacity} ‡∏Ñ‡∏ô\n`;
                
                if (totalTarget > totalCapacity) {
                    confirmMsg += `‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô (${totalTarget} > ${totalCapacity})\n` +
                                  `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö OT ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢!\n`;
                }
                
                if (!confirm(confirmMsg)) return;

                setIsGenerating(true);
                await new Promise(resolve => setTimeout(resolve, 100));

                const days = getDaysInMonth();
                let newSchedule = {}; 
                
                // Initialize clean schedule with 0s
                nurses.forEach(n => {
                    for(let d=1; d<=days; d++) {
                        newSchedule[getKey(n.id, 0, d)] = '0';
                        newSchedule[getKey(n.id, 1, d)] = '0';
                    }
                });

                let nurseStats = {};
                nurses.forEach(n => {
                    nurseStats[n.id] = { total: 0 };
                    shiftConfig.forEach(s => nurseStats[n.id][s.id] = 0);
                });

                const getSortedCandidates = (candidates, shiftId) => {
                    return [...candidates].sort((a, b) => {
                        if (rulesConfig.equalDistribution) {
                            const typeA = nurseStats[a.id][shiftId];
                            const typeB = nurseStats[b.id][shiftId];
                            if (typeA !== typeB) return typeA - typeB;
                        }
                        return nurseStats[a.id].total - nurseStats[b.id].total;
                    });
                };

                for (let d = 1; d <= days; d++) {
                    const isRed = isHoliday(d);
                    const validLabels = shiftConfig.map(s => s.label);

                    // 1. HN Assignment
                    const hn = nurses.find(isHN);
                    let hnShiftId = null;
                    if (hn) {
                        const k1 = getKey(hn.id, 1, d);
                        if (!isRed) {
                            const firstShift = shiftConfig[0]; 
                            if(firstShift) {
                                newSchedule[k1] = firstShift.label;
                                nurseStats[hn.id][firstShift.id]++;
                                nurseStats[hn.id].total++;
                                hnShiftId = firstShift.id;
                            }
                        }
                    }

                    // 2. Identify Available Staff for Normal Shift (Row 1)
                    let availableIds = [];
                    nurses.forEach(n => {
                        if (n.id === hn?.id) return;
                        if (NON_WORKING_CODES.includes(schedule[getKey(n.id, 1, d)])) return; 
                        availableIds.push(n.id);
                    });

                    // 3. Assign Normal Shifts (Row 1)
                    const shiftsPriority = [...shiftConfig].reverse(); 

                    for (const shift of shiftsPriority) {
                        let target = shift.required;
                        let currentCount = (hnShiftId === shift.id) ? 1 : 0;

                        let pool = nurses.filter(n => availableIds.includes(n.id));
                        pool = pool.filter(n => newSchedule[getKey(n.id, 1, d)] === '0');
                        pool = getSortedCandidates(pool, shift.id);

                        if (rulesConfig.noNightToMorning && d > 1) {
                             pool = pool.filter(n => {
                                 const isMorning = (shift.id === shiftConfig[0].id);
                                 if (!isMorning) return true;
                                 
                                 const prevVal = newSchedule[getKey(n.id, 1, d-1)];
                                 const prevShift = shiftConfig.find(s => s.label === prevVal);
                                 return !(prevShift && prevShift.isNight);
                             });
                        }

                        for (let n of pool) {
                            if (currentCount < target) {
                                newSchedule[getKey(n.id, 1, d)] = shift.label;
                                nurseStats[n.id][shift.id]++;
                                nurseStats[n.id].total++;
                                currentCount++;
                            }
                        }
                    }

                    // 4. FORCE FILL GAPS (OT - Row 0)
                    for (const shift of shiftConfig) {
                        const count = countDailyTotal(d, shift.label, newSchedule);
                        if (count < shift.required) {
                            let needed = shift.required - count;
                            
                            let otCandidates = nurses.filter(n => {
                                if (newSchedule[getKey(n.id, 0, d)] !== '0') return false;
                                const myRow1 = newSchedule[getKey(n.id, 1, d)];
                                if (myRow1 === shift.label) return false;
                                if (NON_WORKING_CODES.includes(schedule[getKey(n.id, 1, d)])) return false;
                                return true;
                            });

                            otCandidates = getSortedCandidates(otCandidates, shift.id);

                            for (let n of otCandidates) {
                                if (needed > 0) {
                                    newSchedule[getKey(n.id, 0, d)] = shift.label;
                                    nurseStats[n.id].total++;
                                    needed--;
                                }
                            }
                        }
                    }
                }

                saveData({ schedule: newSchedule });
                setIsGenerating(false);
            };

            const toggleRule = (key) => {
                const newRules = { ...rulesConfig, [key]: !rulesConfig[key] };
                saveData({ rulesConfig: newRules });
            };
            
            const handleSettingsChange = (idx, field, val) => {
                const newShifts = [...shiftConfig];
                newShifts[idx][field] = val;
                saveData({ shiftConfig: newShifts });
            };

            const exportExcel = () => {
                const wb = XLSX.utils.book_new();
                const days = Array.from({length: getDaysInMonth()}, (_, i) => i + 1);
                const data = [];
                data.push(['‡∏•‡∏≥‡∏î‡∏±‡∏ö', '‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', ...days, '‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£', '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£', '‡∏£‡∏ß‡∏° OT', '‡∏Ñ‡πà‡∏≤ OT']);
                nurses.forEach((n, idx) => {
                    const s = countStats(n.id);
                    const row1 = [idx + 1, n.name, n.pos];
                    days.forEach(d => row1.push(schedule[getKey(n.id, 0, d)] || '0'));
                    row1.push(s.workDays, s.shiftPay, s.otCount, s.otPay);
                    const row2 = ['', '', ''];
                    days.forEach(d => row2.push(schedule[getKey(n.id, 1, d)] || '0'));
                    data.push(row1, row2);
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, "Roster");
                XLSX.writeFile(wb, `Roster_Force_${currentDate.getMonth()+1}.xlsx`);
            };

            const cycleShift = (id, row, day) => {
                const key = getKey(id, row, day);
                const current = schedule[key] || '0';
                const shifts = shiftConfig.map(s => s.label);
                const list = row === 0 ? ['0', ...shifts] : ['0', ...shifts, ...Object.keys(LEAVE_TYPES)];
                const nextIndex = (list.indexOf(current) + 1) % list.length;
                saveData({ schedule: { ...schedule, [key]: list[nextIndex] } });
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden bg-gray-50 text-slate-800">
                    <div className="bg-white border-b border-gray-200 shadow-sm shrink-0 z-50">
                        <div className="p-3 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="bg-red-600 text-white p-2 rounded-lg shadow-md">
                                    <Zap size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£ <span className="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">v40.3 Workday</span></h1>
                                    <div className="flex items-center gap-2 text-sm text-gray-500">
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} className="hover:text-red-600"><ChevronLeft size={16}/></button>
                                        <span className="font-semibold w-32 text-center">{currentDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })}</span>
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="hover:text-red-600"><ChevronRight size={16}/></button>
                                    </div>
                                </div>
                            </div>

                            <div className="flex items-center gap-2 no-print">
                                <button onClick={() => setShowSettings(true)} className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-2 border border-gray-300">
                                    <Settings size={16} /> <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                                </button>
                                <div className="h-6 w-px bg-gray-300 mx-2"></div>
                                <button onClick={autoGenerateRoster} disabled={isGenerating} className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1">
                                    {isGenerating ? <div className="spinner w-4 h-4 border-white"></div> : <Zap size={16} />} 
                                    <span>AUTO (Force)</span>
                                </button>
                                <button onClick={exportExcel} className="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1">
                                    <Download size={16} /> <span>Excel</span>
                                </button>
                                <button onClick={() => { if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?")) saveData({ schedule: {} }); }} className="bg-gray-200 hover:bg-red-500 hover:text-white text-gray-600 px-3 py-2 rounded-lg shadow-sm">
                                    <Eraser size={16} />
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-auto bg-gray-100 p-4">
                        <div className="bg-white rounded-lg shadow-lg border border-gray-200 overflow-x-auto max-w-full">
                            <table className="w-full min-w-max">
                                <thead>
                                    <tr>
                                        <th className="sticky-1 w-[40px]">No.</th>
                                        <th className="sticky-2 w-[160px]">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th className="sticky-3 w-[70px]">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                        {Array.from({ length: getDaysInMonth() }, (_, i) => (
                                            <th key={i} onClick={() => {
                                                const day = i + 1;
                                                const newH = customHolidays.includes(day) ? customHolidays.filter(h=>h!==day) : [...customHolidays, day];
                                                saveData({ holidays: newH });
                                            }} className={`min-w-[36px] cursor-pointer hover:bg-gray-200 ${isHoliday(i+1) ? 'bg-red-50 text-red-600' : ''}`}>{i + 1}</th>
                                        ))}
                                        <th className="bg-blue-50 text-blue-900 border-l-2 border-blue-200 min-w-[60px] px-1">‡∏ß‡∏±‡∏ô<br/>‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</th>
                                        <th className="bg-green-50 text-green-900 border-l border-green-200 min-w-[80px] px-1">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£<br/>(‡∏£‡∏ß‡∏°)</th>
                                        <th className="bg-orange-50 text-orange-900 border-l-2 border-orange-200 min-w-[60px] px-1">‡∏£‡∏ß‡∏°<br/>OT</th>
                                        <th className="bg-orange-100 text-orange-900 border-l border-orange-200 min-w-[80px] px-1">‡∏Ñ‡πà‡∏≤ OT<br/>({otRate})</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {nurses.map((nurse, idx) => {
                                        const s = countStats(nurse.id);
                                        const isBalanced = s.workDays === workDayLimit;
                                        const diff = s.workDays - workDayLimit;
                                        return (
                                            <React.Fragment key={nurse.id}>
                                                <tr className="border-b-0 hover:bg-gray-50">
                                                    <td rowSpan={2} className="sticky-1 font-bold text-gray-500 bg-white">{idx + 1}</td>
                                                    <td rowSpan={2} className="sticky-2 text-left px-2 bg-white">{nurse.name}</td>
                                                    <td rowSpan={2} className="sticky-3 font-semibold text-gray-600 bg-white">{nurse.pos}</td>
                                                    {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                        const d = i + 1;
                                                        const val = schedule[getKey(nurse.id, 0, d)] || '0';
                                                        return <td key={`ot-${d}`} onClick={() => cycleShift(nurse.id, 0, d)} className={`cell-hover text-xs ${val !== '0' ? 'font-bold text-red-600 bg-red-50' : 'text-gray-200'}`}>{val}</td>;
                                                    })}
                                                    <td rowSpan={2} className={`font-bold text-sm border-l-2 border-blue-200 ${isBalanced ? 'text-green-600 bg-green-50' : 'text-red-500 bg-white'}`}>
                                                        <div className="flex flex-col items-center justify-center">
                                                            <span className="text-lg">{s.workDays}</span>
                                                            {!isBalanced && (
                                                                <span className="text-[10px] font-normal text-gray-400">
                                                                    {diff > 0 ? `+${diff}` : diff}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td rowSpan={2} className="bg-green-50 text-gray-800 text-xs border-l border-green-200">{s.shiftPay.toLocaleString()}</td>
                                                    <td rowSpan={2} className="bg-orange-50 font-bold text-orange-700 border-l-2 border-orange-200">{s.otCount}</td>
                                                    <td rowSpan={2} className="bg-orange-100 text-orange-800 font-semibold text-xs border-l border-orange-200">{s.otPay.toLocaleString()}</td>
                                                </tr>
                                                <tr className="border-b border-gray-300">
                                                    {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                        const d = i + 1;
                                                        const val = schedule[getKey(nurse.id, 1, d)] || '0';
                                                        const style = getShiftStyle(val);
                                                        return <td key={`norm-${d}`} onClick={() => cycleShift(nurse.id, 1, d)} className={`cell-hover text-xs ${style.color}`}>{style.label}</td>;
                                                    })}
                                                </tr>
                                            </React.Fragment>
                                        );
                                    })}
                                </tbody>
                                <tfoot>
                                    {shiftConfig.map((shift, idx) => (
                                        <tr key={shift.id} className={`font-bold text-xs text-gray-600 ${idx === shiftConfig.length - 1 ? 'border-b-2 border-gray-300' : ''}`}>
                                            <td colSpan="3" className="sticky-1 text-right pr-2 bg-gray-50 z-40">‡∏£‡∏ß‡∏° {shift.name} (‡πÄ‡∏õ‡πâ‡∏≤ {shift.required})</td>
                                            {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                const day = i + 1;
                                                let c = countDailyTotal(day, shift.label);
                                                const target = shift.required;
                                                const status = c < target ? 'bg-red-100 text-red-600' : (c > target ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-700');
                                                return <td key={i} className={status}>{c || '-'}</td>;
                                            })}
                                            <td colSpan="4" className="bg-gray-100"></td>
                                        </tr>
                                    ))}
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100]">
                            <div className="bg-white rounded-lg shadow-xl w-[600px] max-h-[90vh] overflow-y-auto">
                                <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                                    <h3 className="text-lg font-bold flex items-center gap-2"><Settings size={20}/> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
                                    <button onClick={() => setShowSettings(false)} className="text-gray-500 hover:text-black"><X size={20}/></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    {/* 4. WORKDAY TARGET (ADDED HERE) */}
                                    <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                        <div className="flex justify-between items-center">
                                            <h4 className="font-bold text-blue-800">4. ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (Work Days)</h4>
                                            <div className="flex items-center gap-2">
                                                 <span className="text-sm text-blue-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</span>
                                                 <input 
                                                    type="number" 
                                                    className="w-16 border-2 border-blue-300 rounded px-2 py-1 text-center font-bold text-blue-800"
                                                    value={workDayLimit}
                                                    onChange={(e) => saveData({ limit: parseInt(e.target.value)||0 })}
                                                />
                                            </div>
                                        </div>
                                        <p className="text-xs text-blue-600 mt-1">* ‡∏´‡∏≤‡∏Å‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£"</p>
                                    </div>

                                    <div>
                                        <div className="flex justify-between items-center border-b pb-1 mb-2">
                                            <h4 className="font-bold text-gray-700">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏∞‡∏á‡∏≤‡∏ô (Shifts)</h4>
                                            <button onClick={() => setShiftConfig([...shiftConfig, { id: Date.now().toString(), label: '?', name: 'New', color: getRandomColorClass(), price: 0, required: 2, isNight: false }])} className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded flex items-center gap-1 hover:bg-indigo-200 font-bold"><Plus size={12}/> ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                                        </div>
                                        <div className="space-y-3">
                                            {shiftConfig.map((shift, idx) => (
                                                <div key={idx} className="flex items-center gap-2 p-2 bg-gray-50 rounded border group">
                                                    <div className={`w-8 h-8 rounded flex items-center justify-center text-xs font-bold ${shift.color}`}>{shift.label}</div>
                                                    <div className="grid grid-cols-4 gap-2 flex-1">
                                                        <input className="w-full text-xs border rounded p-1" value={shift.label} onChange={e => handleSettingsChange(idx, 'label', e.target.value)} placeholder="‡∏ï‡∏±‡∏ß‡∏¢‡πà‡∏≠" />
                                                        <input className="w-full text-xs border rounded p-1" value={shift.name} onChange={e => handleSettingsChange(idx, 'name', e.target.value)} placeholder="‡∏ä‡∏∑‡πà‡∏≠" />
                                                        <input type="number" className="w-full text-xs border rounded p-1" value={shift.price} onChange={e => handleSettingsChange(idx, 'price', parseInt(e.target.value)||0)} placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" />
                                                        <input type="number" className="w-full text-xs border rounded p-1 font-bold text-blue-600" value={shift.required} onChange={e => handleSettingsChange(idx, 'required', parseInt(e.target.value)||0)} placeholder="‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢" />
                                                    </div>
                                                    <div className="flex flex-col items-center">
                                                        <label className="text-[10px] text-gray-500">‡∏î‡∏∂‡∏Å?</label>
                                                        <input type="checkbox" checked={shift.isNight} onChange={e => handleSettingsChange(idx, 'isNight', e.target.checked)} />
                                                    </div>
                                                    <button onClick={() => setShiftConfig(shiftConfig.filter((_, i) => i !== idx))} className="text-gray-300 hover:text-red-500 p-1"><Trash2 size={14}/></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-6">
                                        <div>
                                            <h4 className="font-bold text-gray-700 mb-2 border-b pb-1">2. ‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô</h4>
                                            <div className="flex items-center justify-between mb-2">
                                                <span className="text-sm">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£ OT</span>
                                                <input type="number" className="border rounded w-20 text-right p-1" value={otRate} onChange={e => saveData({ otRate: parseInt(e.target.value)||0 })} />
                                            </div>
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-gray-700 mb-2 border-b pb-1">3. ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å</h4>
                                            <div className="space-y-2">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm">‡∏´‡πâ‡∏≤‡∏° ‡∏î‡∏∂‡∏Å -> ‡πÄ‡∏ä‡πâ‡∏≤</span>
                                                    <button onClick={() => toggleRule('noNightToMorning')} className={`w-8 h-4 rounded-full transition-colors ${rulesConfig.noNightToMorning ? 'bg-green-500' : 'bg-gray-300'}`}><div className={`w-3 h-3 bg-white rounded-full shadow transform transition-transform ${rulesConfig.noNightToMorning ? 'translate-x-4' : 'translate-x-1'}`}/></button>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm">‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏á‡πÄ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô</span>
                                                    <button onClick={() => toggleRule('noConsecutiveDoubles')} className={`w-8 h-4 rounded-full transition-colors ${rulesConfig.noConsecutiveDoubles ? 'bg-green-500' : 'bg-gray-300'}`}><div className={`w-3 h-3 bg-white rounded-full shadow transform transition-transform ${rulesConfig.noConsecutiveDoubles ? 'translate-x-4' : 'translate-x-1'}`}/></button>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm">‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏ß‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô</span>
                                                    <button onClick={() => toggleRule('equalDistribution')} className={`w-8 h-4 rounded-full transition-colors ${rulesConfig.equalDistribution ? 'bg-green-500' : 'bg-gray-300'}`}><div className={`w-3 h-3 bg-white rounded-full shadow transform transition-transform ${rulesConfig.equalDistribution ? 'translate-x-4' : 'translate-x-1'}`}/></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 bg-gray-50 border-t rounded-b-lg flex justify-end">
                                    <button onClick={() => setShowSettings(false)} className="px-4 py-2 bg-indigo-600 text-white rounded shadow hover:bg-indigo-700 font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<RosterApp />);
    </script>
</body>
</html>
