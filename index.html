<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• v41 - Pattern & Limits</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "xlsx": "https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background-color: #f8fafc; }
        .overflow-x-auto::-webkit-scrollbar { height: 12px; }
        .overflow-x-auto::-webkit-scrollbar-track { background: #f1f5f9; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; border: 2px solid #f1f5f9; }
        table { border-spacing: 0; width: 100%; border-collapse: separate; }
        th, td { white-space: nowrap; text-align: center; border: 1px solid #e2e8f0; height: 32px; padding: 0 4px; font-size: 13px; box-sizing: border-box; }
        .sticky-1 { position: sticky; left: 0; width: 40px; min-width: 40px; background-color: white; z-index: 35; border-right: 1px solid #e2e8f0; }
        .sticky-2 { position: sticky; left: 40px; width: 160px; min-width: 160px; background-color: white; z-index: 35; border-right: 1px solid #e2e8f0; }
        .sticky-3 { position: sticky; left: 200px; width: 150px; min-width: 150px; background-color: white; border-right: 3px solid #cbd5e1; box-shadow: 4px 0 6px -2px rgba(0, 0, 0, 0.1); z-index: 35; }
        thead tr th { position: sticky; top: 0; z-index: 40; background-color: #f1f5f9; color: #334155; height: 50px; }
        thead tr th.sticky-1, thead tr th.sticky-2, thead tr th.sticky-3 { z-index: 50; background-color: #f8fafc; }
        .cell-hover:hover { filter: brightness(0.95); cursor: pointer; transform: scale(1.1); transition: transform 0.1s; z-index: 10; position: relative; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @media print { .no-print { display: none !important; } table { font-size: 10px; width: 100%; } th, td { height: 20px; padding: 0; border: 1px solid #000; } .sticky-1, .sticky-2, .sticky-3 { position: static; border-right: 1px solid #000; box-shadow: none; width: auto; min-width: auto; } body { background-color: white; } .overflow-x-auto { overflow: visible; } }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Download, Calculator, UserPlus, Trash2, ChevronLeft, ChevronRight, Zap, Eraser, Settings, Edit2, Save, X, Plus, Sliders, AlertTriangle } from 'lucide-react';
        import * as XLSX from 'xlsx';

        // --- CONFIG ---
        const DEFAULT_SHIFTS = [
            { id: 'm', label: '‡∏ä', name: '‡πÄ‡∏ä‡πâ‡∏≤', color: 'bg-green-100 text-green-800', price: 0, required: 6, isNight: false }, 
            { id: 'a', label: '‡∏ö', name: '‡∏ö‡πà‡∏≤‡∏¢', color: 'bg-yellow-100 text-yellow-800', price: 360, required: 4, isNight: false },
            { id: 'n', label: '‡∏î', name: '‡∏î‡∏∂‡∏Å', color: 'bg-purple-100 text-purple-800', price: 360, required: 2, isNight: true }
        ];

        const OT_RATE_DEFAULT = 800;
        const NON_WORKING_CODES = ['Va', '‡∏õ‡∏ä', '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', '‡∏•‡∏≤‡∏Å‡∏¥‡∏à'];
        const LEAVE_TYPES = {
            'Va': { label: 'Va', color: 'bg-blue-100 text-blue-800 font-bold text-xs' },
            '‡∏õ‡∏ä': { label: '‡∏õ‡∏ä', color: 'bg-orange-100 text-orange-800 font-bold text-xs' },
            '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢': { label: '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', color: 'bg-red-100 text-red-800 font-bold text-[10px]' },
            '‡∏•‡∏≤‡∏Å‡∏¥‡∏à': { label: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à', color: 'bg-indigo-100 text-indigo-800 font-bold text-[10px]' }
        };

        const INITIAL_NURSES = [
            { id: 1, name: "‡∏ô‡∏≤‡∏á‡∏™‡∏á‡∏ö ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏ò‡∏£‡∏£‡∏°", pos: "‡∏´‡∏ô‡∏ï." },
            { id: 2, name: "‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏©‡∏ì‡∏∏‡∏Å‡∏£‡∏ì‡πå ‡πÇ‡∏¢‡∏¢‡∏≤", pos: "L5" },
            { id: 3, name: "‡∏ô.‡∏™.‡∏à‡∏≤‡∏£‡∏∏‡∏û‡∏£ ‡∏®‡∏£‡∏µ‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥", pos: "L5" },
            { id: 4, name: "‡∏ô.‡∏™.‡πÄ‡∏Ç‡∏°‡∏£‡∏∏‡∏à‡∏¥ ‡∏¢‡∏≤‡∏™‡∏π‡πà", pos: "L4" },
            { id: 5, name: "‡∏ô.‡∏™.‡∏õ‡∏≤‡∏à‡∏≤‡∏£‡∏µ‡∏¢‡πå ‡∏ô‡∏¥‡∏û‡∏±‡∏ô‡∏ò‡πå", pos: "L4" },
            { id: 6, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏ô‡∏¥‡∏™‡∏≤ ‡∏™‡∏∏‡∏Ç‡πÄ‡∏≠‡∏¥‡∏ö", pos: "L4" },
            { id: 7, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏†‡∏≤‡∏ß‡∏î‡∏µ ‡∏¢‡∏°‡∏ô‡πâ‡∏≠‡∏¢", pos: "L2" },
            { id: 8, name: "‡∏ô.‡∏™.‡∏ó‡∏¥‡∏û‡∏õ‡∏†‡∏≤ ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏ò‡∏µ", pos: "L2" },
            { id: 9, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏ô‡∏±‡∏ô‡∏ó‡∏£‡∏≤ ‡πÄ‡∏Å‡∏ï‡∏∏‡∏û‡∏á‡∏©‡πå", pos: "L1" },
            { id: 10, name: "‡∏ô.‡∏™.‡∏™‡∏¥‡∏£‡∏¥‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏ö‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê", pos: "L1" }
        ];

        const getRandomColorClass = () => {
            const colors = ['bg-pink-100 text-pink-800', 'bg-indigo-100 text-indigo-800', 'bg-teal-100 text-teal-800', 'bg-orange-100 text-orange-800'];
            return colors[Math.floor(Math.random() * colors.length)];
        };

        export default function RosterApp() {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [nurses, setNurses] = useState(INITIAL_NURSES);
            const [schedule, setSchedule] = useState({});
            const [customHolidays, setCustomHolidays] = useState([]);
            
            // Limit State
            const [maxShiftsPerMonth, setMaxShiftsPerMonth] = useState(7); // Default limit 7

            const [shiftConfig, setShiftConfig] = useState(DEFAULT_SHIFTS);
            const [otRate, setOtRate] = useState(OT_RATE_DEFAULT);

            const [showModal, setShowModal] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [newNurse, setNewNurse] = useState({ name: '', pos: 'L1' });
            const [editingNurse, setEditingNurse] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);

            useEffect(() => {
                const loadData = () => {
                    const data = localStorage.getItem('roster_data_v41');
                    if (data) {
                        const parsed = JSON.parse(data);
                        setSchedule(parsed.schedule || {});
                        setNurses(parsed.nurses || INITIAL_NURSES);
                        setCustomHolidays(parsed.holidays || []);
                        if(parsed.maxLimit) setMaxShiftsPerMonth(parsed.maxLimit);
                        if (parsed.shiftConfig) setShiftConfig(parsed.shiftConfig);
                        if (parsed.otRate) setOtRate(parsed.otRate);
                    }
                };
                loadData();
            }, []);

            const saveData = (overrides = {}) => {
                const dataToSave = {
                    schedule, nurses, holidays: customHolidays, maxLimit: maxShiftsPerMonth,
                    shiftConfig, otRate,
                    ...overrides
                };
                if (overrides.schedule) setSchedule(overrides.schedule);
                if (overrides.nurses) setNurses(overrides.nurses);
                if (overrides.holidays) setCustomHolidays(overrides.holidays);
                if (overrides.maxLimit) setMaxShiftsPerMonth(overrides.maxLimit);
                if (overrides.shiftConfig) setShiftConfig(overrides.shiftConfig);
                if (overrides.otRate) setOtRate(overrides.otRate);
                localStorage.setItem('roster_data_v41', JSON.stringify(dataToSave));
            };

            const getDaysInMonth = () => new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const getKey = (id, row, day) => `${id}-${row}-${day}`;
            const isHN = (n) => n.pos && n.pos.includes('‡∏´‡∏ô‡∏ï');
            const isHoliday = (day) => {
                const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                return [0, 6].includes(d.getDay()) || customHolidays.includes(day);
            };
            const isWeekend = (day) => {
                const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                return [0, 6].includes(d.getDay());
            };

            const getShiftStyle = (val) => {
                const shift = shiftConfig.find(s => s.label === val);
                if (shift) return { label: shift.label, color: `${shift.color} font-bold` };
                if (LEAVE_TYPES[val]) return LEAVE_TYPES[val];
                return { label: val, color: 'text-gray-300' };
            };

            const countStats = (nurseId) => {
                const days = getDaysInMonth();
                let otCount = 0;
                let workDays = 0;
                let shiftPay = 0;
                let breakdown = { m: 0, a: 0, n: 0 };

                for(let d=1; d<=days; d++) {
                    const valTop = schedule[getKey(nurseId, 0, d)] || '0';
                    const valBot = schedule[getKey(nurseId, 1, d)] || '0';
                    
                    const otShift = shiftConfig.find(s => s.label === valTop);
                    if (otShift) otCount++;

                    const normShift = shiftConfig.find(s => s.label === valBot);
                    if (normShift) {
                        workDays++;
                        shiftPay += normShift.price;
                        if(normShift.id === 'm') breakdown.m++;
                        if(normShift.id === 'a') breakdown.a++;
                        if(normShift.id === 'n') breakdown.n++;
                    }
                    if(otShift) { // Add OT to breakdown
                         if(otShift.id === 'm') breakdown.m++;
                         if(otShift.id === 'a') breakdown.a++;
                         if(otShift.id === 'n') breakdown.n++;
                    }
                }
                const totalShifts = workDays + otCount; // Total slots filled
                return { otCount, otPay: otCount * otRate, shiftPay, workDays, totalShifts, breakdown };
            };

            const countDailyTotal = (day, label, scheduleToUse = schedule) => {
                let count = 0;
                nurses.forEach(n => {
                    if(scheduleToUse[getKey(n.id, 0, day)] === label) count++;
                    if(scheduleToUse[getKey(n.id, 1, day)] === label) count++;
                });
                return count;
            };

            // --- AUTO GENERATE V41: PATTERN & LIMITS ---
            const autoGenerateRoster = async () => {
                if (!confirm(`üéØ ‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£‡πÅ‡∏ö‡∏ö Pattern?\n- ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏£‡∏Ñ‡∏ô‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${maxShiftsPerMonth}\n- ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏ö-‡∏ö-‡∏î-‡∏î\n- ‡∏´‡∏ô‡∏ï. ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ ‡∏à-‡∏®`)) return;

                setIsGenerating(true);
                await new Promise(resolve => setTimeout(resolve, 100));

                const days = getDaysInMonth();
                let newSchedule = {}; 
                // Reset
                nurses.forEach(n => {
                    for(let d=1; d<=days; d++) newSchedule[getKey(n.id, 0, d)] = newSchedule[getKey(n.id, 1, d)] = '0';
                });

                let nurseStats = {};
                nurses.forEach(n => nurseStats[n.id] = 0); // Count total shifts

                // 1. Assign HN (Fixed Rules)
                const hn = nurses.find(isHN);
                if (hn) {
                    for (let d = 1; d <= days; d++) {
                        if (!isHoliday(d) && !isWeekend(d)) {
                             // Only assign if limit allows (though HN usually works all workdays, user said rules apply)
                             // HN usually works ~20 days. If limit is 7, HN will stop at 7.
                             // Let's assume HN Rule overrides Limit if it's "Workdays", 
                             // BUT user said "shifts <= 7". I will respect the limit strictly as requested.
                             if (nurseStats[hn.id] < maxShiftsPerMonth) {
                                newSchedule[getKey(hn.id, 1, d)] = '‡∏ä'; 
                                nurseStats[hn.id]++;
                             }
                        }
                    }
                }

                // 2. Assign Pattern A-A-N-N (‡∏ö-‡∏ö-‡∏î-‡∏î) for others
                // We'll stagger start days to cover the whole month
                const normalNurses = nurses.filter(n => !isHN(n));
                const pattern = ['‡∏ö', '‡∏ö', '‡∏î', '‡∏î'];
                
                // Shuffle nurses to distribute pattern starts randomly
                const shuffledNurses = [...normalNurses].sort(() => Math.random() - 0.5);

                shuffledNurses.forEach((n, idx) => {
                    // Stagger start: Nurse 1 starts day 1, Nurse 2 starts day 2...
                    // Loop through month
                    let currentPatternIdx = 0;
                    // Start day offset based on index to spread coverage
                    let startOffset = (idx * 2) % 4; 
                    
                    for (let d = 1; d <= days; d++) {
                         // Check leaves
                         if (NON_WORKING_CODES.includes(schedule[getKey(n.id, 1, d)])) continue;
                         
                         // Try to apply pattern if valid
                         let pChar = pattern[(d + startOffset) % 4];
                         
                         // Logic: "Pattern" usually implies rotation. 
                         // Let's try to place chunks.
                         // Simple approach: Iterate days. If spot free and limit ok, place pattern char.
                         // But we must check if that char is NEEDED. 
                         // Pattern approach is good for supply, but we have Demand targets.
                         
                         // Modified Pattern Logic: Place A-A-N-N blocks *if needed* and *if limit allows*
                    }
                });
                
                // REVISED LOGIC: Demand-Driven with Pattern Preference
                // Iterate Day by Day
                
                for (let d = 1; d <= days; d++) {
                    const demand = shiftConfig.map(s => ({...s, current: countDailyTotal(d, s.label, newSchedule)}));
                    
                    // Sort demand by most needed (Night > Afternoon > Morning usually)
                    // But for pattern A-A-N-N, we prioritize continuity.
                    
                    // 2.1 Check if anyone is "In Pattern" from yesterday
                    normalNurses.forEach(n => {
                        if (nurseStats[n.id] >= maxShiftsPerMonth) return;
                        
                        const yest = d > 1 ? newSchedule[getKey(n.id, 1, d-1)] : '0';
                        let preferred = null;
                        
                        // Pattern Logic: 
                        // If yesterday B (A), today prefer B (A) or D (N)
                        // If yesterday D (N), today prefer D (N) or Off
                        // Standard: B -> B -> D -> D -> Off
                        
                        if (yest === '‡∏ö') preferred = '‡∏ö'; // B -> B
                        else if (yest === '‡∏ö' && newSchedule[getKey(n.id, 1, d-2)] === '‡∏ö') preferred = '‡∏î'; // B B -> D (Logic check: need history)
                        // Actually easier: look back.
                        const dMinus1 = d > 1 ? newSchedule[getKey(n.id, 1, d-1)] : '0';
                        const dMinus2 = d > 2 ? newSchedule[getKey(n.id, 1, d-2)] : '0';
                        const dMinus3 = d > 3 ? newSchedule[getKey(n.id, 1, d-3)] : '0';

                        if (dMinus1 === '‡∏ö') {
                            if (dMinus2 !== '‡∏ö') preferred = '‡∏ö'; // First B -> Second B
                            else preferred = '‡∏î'; // Second B -> First D
                        } else if (dMinus1 === '‡∏î') {
                            if (dMinus2 !== '‡∏î') preferred = '‡∏î'; // First D -> Second D
                            else preferred = null; // Second D -> Off
                        } else {
                            // Yesterday was Off or Morning. Start new pattern?
                            // preferred = '‡∏ö'; // Start with B
                        }
                        
                        // Try to assign preferred if needed
                        if (preferred) {
                            const shiftDef = shiftConfig.find(s => s.label === preferred);
                            if (shiftDef) {
                                const currentCount = countDailyTotal(d, preferred, newSchedule);
                                if (currentCount < shiftDef.required) {
                                    newSchedule[getKey(n.id, 1, d)] = preferred;
                                    nurseStats[n.id]++;
                                }
                            }
                        }
                    });
                }

                // 3. Fill Remaining Gaps (Greedy Equal Dist)
                for (let d = 1; d <= days; d++) {
                    // Priority: N -> A -> M
                    const shifts = [...shiftConfig].sort((a,b) => {
                         // N=2 (isNight), A=1, M=0 priority
                         if(a.isNight) return -1;
                         if(b.isNight) return 1;
                         return b.price - a.price; 
                    });

                    for (const shift of shifts) {
                        let current = countDailyTotal(d, shift.label, newSchedule);
                        while (current < shift.required) {
                            // Find candidate
                            let candidates = normalNurses.filter(n => {
                                if (nurseStats[n.id] >= maxShiftsPerMonth) return false;
                                if (newSchedule[getKey(n.id, 1, d)] !== '0') return false; // Already working
                                if (NON_WORKING_CODES.includes(schedule[getKey(n.id, 1, d)])) return false;
                                
                                // Rule: No N -> M
                                if (shift.label === '‡∏ä' && d > 1 && newSchedule[getKey(n.id, 1, d-1)] === '‡∏î') return false;
                                
                                return true;
                            });

                            // Sort by least shifts
                            candidates.sort((a,b) => nurseStats[a.id] - nurseStats[b.id]);

                            if (candidates.length > 0) {
                                const n = candidates[0];
                                newSchedule[getKey(n.id, 1, d)] = shift.label;
                                nurseStats[n.id]++;
                                current++;
                            } else {
                                break; // No one available (hit limits)
                            }
                        }
                    }
                }

                saveData({ schedule: newSchedule });
                setIsGenerating(false);
            };

            const toggleRule = (key) => {
                // ... legacy code
            };
            
            const handleSettingsChange = (idx, field, val) => {
                const newShifts = [...shiftConfig];
                newShifts[idx][field] = val;
                saveData({ shiftConfig: newShifts });
            };

            const cycleShift = (id, row, day) => {
                const key = getKey(id, row, day);
                const current = schedule[key] || '0';
                const shifts = shiftConfig.map(s => s.label);
                const list = row === 0 ? ['0', ...shifts] : ['0', ...shifts, ...Object.keys(LEAVE_TYPES)];
                const nextIndex = (list.indexOf(current) + 1) % list.length;
                saveData({ schedule: { ...schedule, [key]: list[nextIndex] } });
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden bg-gray-50 text-slate-800">
                    <div className="bg-white border-b border-gray-200 shadow-sm shrink-0 z-50">
                        <div className="p-3 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="bg-purple-600 text-white p-2 rounded-lg shadow-md">
                                    <Sliders size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-800">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£ v41 <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">Pattern & Limit</span></h1>
                                    <div className="flex items-center gap-2 text-sm text-gray-500">
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} className="hover:text-purple-600"><ChevronLeft size={16}/></button>
                                        <span className="font-semibold w-32 text-center">{currentDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })}</span>
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="hover:text-purple-600"><ChevronRight size={16}/></button>
                                    </div>
                                </div>
                            </div>

                            <div className="flex items-center gap-2 no-print">
                                <button onClick={() => setShowSettings(true)} className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-2 border border-gray-300">
                                    <Settings size={16} /> <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                                </button>
                                <div className="h-6 w-px bg-gray-300 mx-2"></div>
                                <button onClick={autoGenerateRoster} disabled={isGenerating} className="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1">
                                    {isGenerating ? <div className="spinner w-4 h-4 border-white"></div> : <Zap size={16} />} 
                                    <span>‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£ (Pattern)</span>
                                </button>
                                <button onClick={() => { if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?")) saveData({ schedule: {} }); }} className="bg-gray-200 hover:bg-red-500 hover:text-white text-gray-600 px-3 py-2 rounded-lg shadow-sm">
                                    <Eraser size={16} />
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-auto bg-gray-100 p-4">
                        <div className="bg-white rounded-lg shadow-lg border border-gray-200 overflow-x-auto max-w-full">
                            <table className="w-full min-w-max">
                                <thead>
                                    <tr>
                                        <th className="sticky-1 w-[40px]">No.</th>
                                        <th className="sticky-2 w-[160px]">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th className="sticky-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Limit {maxShiftsPerMonth})</th>
                                        {Array.from({ length: getDaysInMonth() }, (_, i) => (
                                            <th key={i} onClick={() => {
                                                const day = i + 1;
                                                const newH = customHolidays.includes(day) ? customHolidays.filter(h=>h!==day) : [...customHolidays, day];
                                                saveData({ holidays: newH });
                                            }} className={`min-w-[36px] cursor-pointer hover:bg-gray-200 ${isHoliday(i+1) ? 'bg-red-50 text-red-600' : ''}`}>{i + 1}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {nurses.map((nurse, idx) => {
                                        const s = countStats(nurse.id);
                                        const isLimitExceeded = s.totalShifts > maxShiftsPerMonth;
                                        const isLimitReached = s.totalShifts === maxShiftsPerMonth;
                                        const limitColor = isLimitExceeded ? 'text-red-600 bg-red-100' : (isLimitReached ? 'text-green-600 bg-green-50' : 'text-gray-500');

                                        return (
                                            <React.Fragment key={nurse.id}>
                                                <tr className="border-b-0 hover:bg-gray-50">
                                                    <td rowSpan={2} className="sticky-1 font-bold text-gray-500 bg-white">{idx + 1}</td>
                                                    <td rowSpan={2} className="sticky-2 text-left px-2 bg-white">
                                                        <div className="font-bold text-sm">{nurse.name}</div>
                                                        <div className="text-[10px] text-gray-500 bg-gray-100 px-1 rounded inline-block">{nurse.pos}</div>
                                                    </td>
                                                    <td rowSpan={2} className="sticky-3 bg-white border-r-4 border-gray-100 p-1">
                                                        <div className={`text-xs font-bold px-2 py-1 rounded text-center ${limitColor} mb-1`}>
                                                            ‡∏£‡∏ß‡∏°: {s.totalShifts} / {maxShiftsPerMonth}
                                                        </div>
                                                        <div className="flex justify-center gap-1 text-[10px]">
                                                            <span className="bg-green-100 text-green-800 px-1 rounded">‡∏ä:{s.breakdown.m}</span>
                                                            <span className="bg-yellow-100 text-yellow-800 px-1 rounded">‡∏ö:{s.breakdown.a}</span>
                                                            <span className="bg-purple-100 text-purple-800 px-1 rounded">‡∏î:{s.breakdown.n}</span>
                                                        </div>
                                                    </td>
                                                    {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                        const d = i + 1;
                                                        const val = schedule[getKey(nurse.id, 0, d)] || '0';
                                                        return <td key={`ot-${d}`} onClick={() => cycleShift(nurse.id, 0, d)} className={`cell-hover text-xs ${val !== '0' ? 'font-bold text-red-600 bg-red-50' : 'text-gray-200'}`}>{val}</td>;
                                                    })}
                                                </tr>
                                                <tr className="border-b border-gray-300">
                                                    {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                        const d = i + 1;
                                                        const val = schedule[getKey(nurse.id, 1, d)] || '0';
                                                        const style = getShiftStyle(val);
                                                        return <td key={`norm-${d}`} onClick={() => cycleShift(nurse.id, 1, d)} className={`cell-hover text-xs ${style.color}`}>{style.label}</td>;
                                                    })}
                                                </tr>
                                            </React.Fragment>
                                        );
                                    })}
                                </tbody>
                                <tfoot>
                                    {shiftConfig.map((shift, idx) => (
                                        <tr key={shift.id} className={`font-bold text-xs text-gray-600 ${idx === shiftConfig.length - 1 ? 'border-b-2 border-gray-300' : ''}`}>
                                            <td colSpan="3" className="sticky-1 text-right pr-2 bg-gray-50 z-40">‡∏£‡∏ß‡∏° {shift.name} (‡πÄ‡∏õ‡πâ‡∏≤ {shift.required})</td>
                                            {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                const day = i + 1;
                                                let c = countDailyTotal(day, shift.label);
                                                const target = shift.required;
                                                const status = c < target ? 'bg-red-100 text-red-600' : (c > target ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-700');
                                                return <td key={i} className={status}>{c || '-'}</td>;
                                            })}
                                        </tr>
                                    ))}
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100]">
                            <div className="bg-white rounded-lg shadow-xl w-[500px]">
                                <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                                    <h3 className="text-lg font-bold flex items-center gap-2"><Settings size={20}/> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
                                    <button onClick={() => setShowSettings(false)} className="text-gray-500 hover:text-black"><X size={20}/></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                                        <div className="flex justify-between items-center">
                                            <h4 className="font-bold text-purple-800">1. ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏£ (Max Shift Limit)</h4>
                                            <div className="flex items-center gap-2">
                                                 <span className="text-sm text-purple-600">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô:</span>
                                                 <input 
                                                    type="number" 
                                                    className="w-16 border-2 border-purple-300 rounded px-2 py-1 text-center font-bold text-purple-800"
                                                    value={maxShiftsPerMonth}
                                                    onChange={(e) => saveData({ maxLimit: parseInt(e.target.value)||0 })}
                                                />
                                                 <span className="text-sm text-purple-600">‡πÄ‡∏ß‡∏£/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 bg-gray-50 border-t rounded-b-lg flex justify-end">
                                    <button onClick={() => setShowSettings(false)} className="px-4 py-2 bg-purple-600 text-white rounded shadow hover:bg-purple-700 font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<RosterApp />);
    </script>
</body>
</html>
