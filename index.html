<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• v40 - L1-L5 Limit 7 Days</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "xlsx": "https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            margin: 0;
            padding: 0;
            background-color: #f8fafc;
        }
        
        .overflow-x-auto::-webkit-scrollbar { height: 12px; }
        .overflow-x-auto::-webkit-scrollbar-track { background: #f1f5f9; }
        .overflow-x-auto::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 6px; 
            border: 2px solid #f1f5f9; 
        }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        table { 
            border-spacing: 0;
            width: 100%;
            border-collapse: separate; /* Fix for sticky borders */
        }
        
        th, td {
            white-space: nowrap;
            text-align: center;
            border: 1px solid #e2e8f0;
            height: 32px;
            padding: 0 4px;
            font-size: 13px;
            box-sizing: border-box;
        }

        /* Sticky Columns Left */
        .sticky-1 { 
            position: sticky; 
            left: 0; 
            width: 40px; 
            min-width: 40px; 
            background-color: white; 
            z-index: 35; 
            border-right: 1px solid #e2e8f0;
        }
        
        .sticky-2 { 
            position: sticky; 
            left: 40px; 
            width: 160px; 
            min-width: 160px; 
            background-color: white; 
            z-index: 35; 
            border-right: 1px solid #e2e8f0;
        }
        
        .sticky-3 { 
            position: sticky; 
            left: 200px; 
            width: 70px; 
            min-width: 70px; 
            background-color: white; 
            border-right: 3px solid #cbd5e1; 
            box-shadow: 4px 0 6px -2px rgba(0, 0, 0, 0.1); 
            z-index: 35; 
        }
        
        thead tr th { 
            position: sticky; 
            top: 0; 
            z-index: 40; 
            background-color: #f1f5f9; 
            color: #334155;
            height: 50px;
        }
        
        thead tr th.sticky-1, 
        thead tr th.sticky-2, 
        thead tr th.sticky-3 { 
            z-index: 50; 
            background-color: #f8fafc;
        }

        .cell-hover:hover { 
            filter: brightness(0.95); 
            cursor: pointer; 
            transform: scale(1.1);
            transition: transform 0.1s;
            z-index: 10;
            position: relative;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        
        .header-hover:hover { 
            background-color: #e2e8f0; 
            cursor: pointer; 
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #22c55e;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #22c55e;
        }

        /* Loading Spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0ea5e9;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @media print {
            .no-print { display: none !important; }
            table { font-size: 10px; width: 100%; }
            th, td { height: 20px; padding: 0; border: 1px solid #000; }
            .sticky-1, .sticky-2, .sticky-3 { position: static; border-right: 1px solid #000; box-shadow: none; width: auto; min-width: auto; }
            body { background-color: white; }
            .overflow-x-auto { overflow: visible; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Download, Calculator, UserPlus, Trash2, ChevronLeft, ChevronRight, Zap, Eraser, Settings, Edit2, Save, X, Info, BarChart3, AlertCircle, Plus } from 'lucide-react';
        import * as XLSX from 'xlsx';

        // --- CONSTANTS & DEFAULTS ---
        const DEFAULT_SETTINGS = {
            workDayTarget: 20,
            otRate: 800,
            shifts: [
                { id: 'm', symbol: '‡∏ä', name: '‡πÄ‡∏ä‡πâ‡∏≤', price: 0, target: 5, isNight: false, color: 'bg-green-100 text-green-800 font-bold' },
                { id: 'a', symbol: '‡∏ö', name: '‡∏ö‡πà‡∏≤‡∏¢', price: 360, target: 3, isNight: false, color: 'bg-yellow-100 text-yellow-800 font-bold' },
                { id: 'n', symbol: '‡∏î', name: '‡∏î‡∏∂‡∏Å', price: 360, target: 2, isNight: true, color: 'bg-purple-100 text-purple-800 font-bold' }
            ],
            rules: {
                noNightToMorning: true,
                noDoubleShift: false, 
                balanceShifts: true,
                limitSevenDays: true // NEW RULE: Limit 7 consecutive days for L1-L5
            }
        };

        const NON_WORKING_CODES = ['Va', '‡∏õ‡∏ä','‡∏•‡∏≤‡∏Å‡∏¥‡∏à'];
        const STATIC_STYLES = {
            '0':      { label: '0',      color: 'bg-white text-red-300' },
            'Va':     { label: 'Va',     color: 'bg-blue-100 text-blue-800 font-bold text-xs' },
            '‡∏õ‡∏ä':     { label: '‡∏õ‡∏ä',     color: 'bg-orange-100 text-orange-800 font-bold text-xs' },
            '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢': { label: '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', color: 'bg-red-100 text-red-800 font-bold text-[10px]' },
            '‡∏•‡∏≤‡∏Å‡∏¥‡∏à':  { label: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à',  color: 'bg-indigo-100 text-indigo-800 font-bold text-[10px]' }
        };

        const INITIAL_NURSES = [
            { id: 1, name: "‡∏ô‡∏≤‡∏á‡∏™‡∏á‡∏ö ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏ò‡∏£‡∏£‡∏°", pos: "‡∏´‡∏ô‡∏ï." },
            { id: 2, name: "‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏©‡∏ì‡∏∏‡∏Å‡∏£‡∏ì‡πå ‡πÇ‡∏≠‡∏¢‡∏≤", pos: "L5" },
            { id: 3, name: "‡∏ô.‡∏™.‡∏à‡∏≤‡∏£‡∏∏‡∏û‡∏£ ‡∏®‡∏£‡∏µ‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏û‡∏ö‡∏π‡∏•‡∏¢‡πå", pos: "L5" },
            { id: 4, name: "‡∏ô.‡∏™.‡πÄ‡∏Ç‡∏°‡∏£‡∏∏‡∏à‡∏¥ ‡∏¢‡∏≤‡∏™‡∏ö‡∏π‡πà", pos: "L4" },
            { id: 5, name: "‡∏ô.‡∏™.‡∏õ‡∏≤‡∏à‡∏≤‡∏£‡∏µ‡∏¢‡πå ‡∏ô‡∏¥‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏õ‡∏£‡∏∞‡∏®‡∏≤‡∏™‡∏ô‡πå", pos: "L4" },
            { id: 6, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏ô‡∏¥‡∏™‡∏≤ ‡∏™‡∏∏‡∏Ç‡πÄ‡∏≠‡∏¥‡∏ö", pos: "L4" },
            { id: 7, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏†‡∏≤‡∏ß‡∏î‡∏µ ‡∏¢‡∏°‡∏ô‡πâ‡∏≠‡∏¢", pos: "L4" },
            { id: 8, name: "‡∏ô.‡∏™.‡∏ó‡∏¥‡∏û‡∏õ‡∏†‡∏≤ ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏ò‡∏µ", pos: "L2" },
            { id: 9, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏ô‡∏±‡∏ô‡∏ó‡∏£‡∏≤ ‡πÄ‡∏Å‡∏ï‡∏∏‡∏û‡∏á‡∏©‡πå", pos: "L2" },
            { id: 10, name: "‡∏ô.‡∏™.‡∏™‡∏¥‡∏£‡∏¥‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏ö‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê", pos: "L1" }
        ];

        const ToggleSwitch = ({ checked, onChange }) => (
            <div className="relative inline-block w-10 h-5 align-middle select-none transition duration-200 ease-in">
                <input 
                    type="checkbox" 
                    checked={checked} 
                    onChange={(e) => onChange(e.target.checked)} 
                    className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 checked:border-green-500 checked:right-0 transition-all duration-200"
                />
                <label className={`toggle-label block overflow-hidden h-5 rounded-full cursor-pointer transition-colors duration-200 ${checked ? 'bg-green-500' : 'bg-gray-300'}`}></label>
            </div>
        );

        export default function RosterApp() {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [nurses, setNurses] = useState(INITIAL_NURSES);
            const [schedule, setSchedule] = useState({});
            const [customHolidays, setCustomHolidays] = useState([]);
            const [settings, setSettings] = useState(DEFAULT_SETTINGS);
            
            const [showModal, setShowModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [newNurse, setNewNurse] = useState({ name: '', pos: 'L1' });
            const [customConditions, setCustomConditions] = useState('');
            const [editingNurse, setEditingNurse] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);

            useEffect(() => {
                const savedData = localStorage.getItem('roster_data_v40');
                const savedNurses = localStorage.getItem('roster_nurses_v40');
                const savedHolidays = localStorage.getItem('roster_holidays_v40');
                const savedSettings = localStorage.getItem('roster_settings_v40');
                const savedConditions = localStorage.getItem('roster_conditions_v40');
                
                if (savedData) setSchedule(JSON.parse(savedData));
                if (savedNurses) setNurses(JSON.parse(savedNurses));
                if (savedHolidays) setCustomHolidays(JSON.parse(savedHolidays));
                if (savedSettings) setSettings(JSON.parse(savedSettings));
                if (savedConditions) setCustomConditions(savedConditions);
            }, []);

            const saveAll = (updatedNurses, updatedSchedule, updatedHolidays, updatedSettings, updatedConditions) => {
                if(updatedNurses) {
                    setNurses(updatedNurses);
                    localStorage.setItem('roster_nurses_v40', JSON.stringify(updatedNurses));
                }
                if(updatedSchedule) {
                    setSchedule(updatedSchedule);
                    localStorage.setItem('roster_data_v40', JSON.stringify(updatedSchedule));
                }
                if(updatedHolidays) {
                    setCustomHolidays(updatedHolidays);
                    localStorage.setItem('roster_holidays_v40', JSON.stringify(updatedHolidays));
                }
                if(updatedSettings) {
                    setSettings(updatedSettings);
                    localStorage.setItem('roster_settings_v40', JSON.stringify(updatedSettings));
                }
                if(updatedConditions !== undefined) {
                    setCustomConditions(updatedConditions);
                    localStorage.setItem('roster_conditions_v40', updatedConditions);
                }
            };

            const getDaysInMonth = () => new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const getKey = (id, row, day) => `${id}-${row}-${day}`;
            const isHN = (n) => n.pos && n.pos.includes('‡∏´‡∏ô‡∏ï');
            
            const isHoliday = (day) => {
                const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                return [0, 6].includes(d.getDay()) || customHolidays.includes(day);
            };

            const getShiftBySymbol = (symbol) => settings.shifts.find(s => s.symbol === symbol);

            const countStats = (nurseId) => {
                const days = getDaysInMonth();
                let otCount = 0;
                let bdCount = 0;
                let bdPay = 0;
                let workDays = 0;
                
                const workingSymbols = settings.shifts.map(s => s.symbol);

                for(let d=1; d<=days; d++) {
                    const valTop = schedule[getKey(nurseId, 0, d)] || '0';
                    const valBot = schedule[getKey(nurseId, 1, d)] || '0';
                    
                    if (workingSymbols.includes(valTop)) {
                        otCount++;
                    }

                    if (workingSymbols.includes(valBot)) {
                        const shift = getShiftBySymbol(valBot);
                        if (shift) {
                             if (shift.price > 0) {
                                 bdCount++;
                                 bdPay += shift.price;
                             }
                             workDays++;
                        }
                    }
                }

                return {
                    otCount,
                    otPay: otCount * settings.otRate,
                    bdCount,
                    bdPay,
                    workDays
                };
            };

            const countDailyTotal = (day, type, scheduleToUse = schedule) => {
                let count = 0;
                nurses.forEach(n => {
                    if(scheduleToUse[getKey(n.id, 0, day)] === type) count++;
                    if(scheduleToUse[getKey(n.id, 1, day)] === type) count++;
                });
                return count;
            };

            // --- AUTO GENERATE ---
            const autoGenerateRoster = async () => {
                const rules = settings.rules;
                const confirmMsg = `üéØ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£ (v40)?\n\n` +
                                 `‚Ä¢ L1-L5 ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 7 ‡∏ß‡∏±‡∏ô: ${rules.limitSevenDays ? '‚úÖ' : '‚ùå'}\n` +
                                 `‚Ä¢ ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£‡πÄ‡∏î‡∏¥‡∏°/Va: ‚úÖ\n` +
                                 `‚Ä¢ ‡∏´‡πâ‡∏≤‡∏°‡∏î‡∏∂‡∏Å->‡πÄ‡∏ä‡πâ‡∏≤: ${rules.noNightToMorning ? '‚úÖ' : '‚ùå'}\n` +
                                 `‚Ä¢ ‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏ß‡∏£: ${rules.balanceShifts ? '‚úÖ' : '‚ùå'}\n`;
                
                if (!confirm(confirmMsg)) return;

                setIsGenerating(true);
                await new Promise(resolve => setTimeout(resolve, 100));

                const days = getDaysInMonth();
                let newSchedule = { ...schedule };
                const workingSymbols = settings.shifts.map(s => s.symbol);
                
                // 1. Reset logic: Clear ONLY auto-generated working shifts, Keep Va/Pre-set codes
                nurses.forEach(n => {
                    for(let d=1; d<=days; d++) {
                        const keyBot = getKey(n.id, 1, d);
                        const keyTop = getKey(n.id, 0, d);
                        const valBot = newSchedule[keyBot];
                        const valTop = newSchedule[keyTop];

                        // Keep if it is Va, Leave, or any non-working code
                        if (NON_WORKING_CODES.includes(valBot)) {
                            // Do nothing, preserve it
                        } else if (workingSymbols.includes(valBot)) {
                            newSchedule[keyBot] = '0'; // Reset working shift
                        }

                        if (workingSymbols.includes(valTop)) {
                             newSchedule[keyTop] = '0';
                        }
                    }
                });

                let nurseStats = {};
                nurses.forEach(n => nurseStats[n.id] = { m: 0, a: 0, n: 0, total: 0 });

                // --- Helper: Check Consecutive Days ---
                const getConsecutiveWorkDays = (nurseId, currentDay) => {
                    let count = 0;
                    for (let i = currentDay - 1; i >= 1; i--) {
                        const k1 = getKey(nurseId, 1, i);
                        const k0 = getKey(nurseId, 0, i);
                        // Check if worked EITHER shift
                        const worked = workingSymbols.includes(newSchedule[k1]) || workingSymbols.includes(newSchedule[k0]);
                        if (worked) {
                            count++;
                        } else {
                            break;
                        }
                    }
                    return count;
                };

                const getSortedCandidates = (candidates, shiftId) => {
                    if (!settings.rules.balanceShifts) return candidates; 

                    return [...candidates].sort((a, b) => {
                        const typeA = nurseStats[a.id][shiftId] || 0;
                        const typeB = nurseStats[b.id][shiftId] || 0;
                        if (typeA !== typeB) return typeA - typeB;
                        return nurseStats[a.id].total - nurseStats[b.id].total;
                    });
                };

                const wasDoubleYesterday = (nurseId, currentDay) => {
                    if (currentDay <= 1) return false;
                    const k0 = getKey(nurseId, 0, currentDay - 1);
                    const k1 = getKey(nurseId, 1, currentDay - 1);
                    return (workingSymbols.includes(newSchedule[k0]) && workingSymbols.includes(newSchedule[k1]));
                };

                const mShift = settings.shifts.find(s => s.symbol === '‡∏ä') || settings.shifts[0];
                const aShift = settings.shifts.find(s => s.symbol === '‡∏ö') || settings.shifts[1];
                const nShift = settings.shifts.find(s => s.symbol === '‡∏î') || settings.shifts[2];

                for (let d = 1; d <= days; d++) {
                    const isRed = isHoliday(d);
                    const targetM = mShift.target;
                    const targetA = aShift.target;
                    const targetN = nShift.target;

                    // --- 1. Pre-Assign HN ---
                    const hn = nurses.find(isHN);
                    let hnWorked = false;
                    if (hn) {
                        const k1 = getKey(hn.id, 1, d);
                        // Only assign if empty (0) to respect manual overrides
                        if (!NON_WORKING_CODES.includes(newSchedule[k1]) && newSchedule[k1] === '0') {
                            if (!isRed) {
                                newSchedule[k1] = mShift.symbol;
                                nurseStats[hn.id].m++;
                                nurseStats[hn.id].total++;
                                hnWorked = true;
                            }
                        } else if (workingSymbols.includes(newSchedule[k1])) {
                             // Already manually set to a shift
                             if(newSchedule[k1] === mShift.symbol) hnWorked = true;
                             nurseStats[hn.id].total++;
                        }
                    }

                    // --- 2. Identify Available Staff ---
                    let availableIds = [];
                    nurses.forEach(n => {
                        if (n.id === hn?.id) return;
                        const k1 = getKey(n.id, 1, d);
                        
                        // If pre-assigned (Va, Manual Shift), count stats and skip logic
                        if (NON_WORKING_CODES.includes(newSchedule[k1])) return;
                        if (workingSymbols.includes(newSchedule[k1])) {
                             // If manual shift exists, just count it and don't re-assign
                             // We don't push to availableIds because they are already booked
                             if(newSchedule[k1] === mShift.symbol) nurseStats[n.id].m++;
                             if(newSchedule[k1] === aShift.symbol) nurseStats[n.id].a++;
                             if(newSchedule[k1] === nShift.symbol) nurseStats[n.id].n++;
                             nurseStats[n.id].total++;
                             return;
                        }

                        // IRON RULE #1: No Night -> Morning
                        if (settings.rules.noNightToMorning) {
                            if (d > 1 && newSchedule[getKey(n.id, 1, d-1)] === nShift.symbol) return;
                        }

                        // IRON RULE #NEW: Limit 7 Consecutive Days (L1-L5)
                        if (settings.rules.limitSevenDays) {
                            // Check if pos starts with L (L1, L2, L3, L4, L5)
                            if (['L1','L2','L3','L4','L5'].includes(n.pos)) {
                                const consecutive = getConsecutiveWorkDays(n.id, d);
                                if (consecutive >= 7) {
                                    return; // Must rest today
                                }
                            }
                        }

                        availableIds.push(n.id);
                    });

                    let candidates = nurses.filter(n => availableIds.includes(n.id));
                    let assignedToday = [];

                    // --- 3. Assign Night ---
                    // Subtract pre-filled slots from target
                    let currentCountN = countDailyTotal(d, nShift.symbol, newSchedule);
                    let neededN = targetN - currentCountN;
                    
                    if (neededN > 0) {
                        let nightPool = getSortedCandidates(candidates, 'n');
                        for (let n of nightPool) {
                            if (neededN > 0) {
                                newSchedule[getKey(n.id, 1, d)] = nShift.symbol;
                                assignedToday.push(n.id);
                                nurseStats[n.id].n++;
                                nurseStats[n.id].total++;
                                neededN--;
                            }
                        }
                        candidates = candidates.filter(n => !assignedToday.includes(n.id));
                    }

                    // --- 4. Assign Afternoon ---
                    let currentCountA = countDailyTotal(d, aShift.symbol, newSchedule);
                    let neededA = targetA - currentCountA;

                    if (neededA > 0) {
                        let afternoonPool = getSortedCandidates(candidates, 'a');
                        for (let n of afternoonPool) {
                            if (neededA > 0) {
                                newSchedule[getKey(n.id, 1, d)] = aShift.symbol;
                                assignedToday.push(n.id);
                                nurseStats[n.id].a++;
                                nurseStats[n.id].total++;
                                neededA--;
                            }
                        }
                        candidates = candidates.filter(n => !assignedToday.includes(n.id));
                    }

                    // --- 5. Assign Morning ---
                    let currentCountM = countDailyTotal(d, mShift.symbol, newSchedule);
                    // HN is usually included in countDailyTotal if assigned above
                    let neededM = targetM - currentCountM;

                    if (neededM > 0) {
                        let morningPool = getSortedCandidates(candidates, 'm');
                        for (let n of morningPool) {
                            if (neededM > 0) {
                                newSchedule[getKey(n.id, 1, d)] = mShift.symbol;
                                assignedToday.push(n.id);
                                nurseStats[n.id].m++;
                                nurseStats[n.id].total++;
                                neededM--;
                            }
                        }
                    }

                    // --- 6. Fill Gaps with OT ---
                    
                    // Recount after normal assignments
                    let finalM = countDailyTotal(d, mShift.symbol, newSchedule);
                    let finalA = countDailyTotal(d, aShift.symbol, newSchedule);

                    // Fill M gap (OT Morning for Afternoon Nurse)
                    if (finalM < targetM) {
                        let needed = targetM - finalM;
                        // Find nurses working Afternoon TODAY
                        let doublePool = nurses.filter(n => newSchedule[getKey(n.id, 1, d)] === aShift.symbol); 
                        doublePool = getSortedCandidates(doublePool, 'm');
                        for (let n of doublePool) {
                            if (needed > 0) {
                                // Double Check manual OT override
                                if (newSchedule[getKey(n.id, 0, d)] !== '0') continue; // Already has OT

                                if (settings.rules.noDoubleShift && wasDoubleYesterday(n.id, d)) continue; 

                                newSchedule[getKey(n.id, 0, d)] = mShift.symbol;
                                nurseStats[n.id].total++;
                                needed--;
                            }
                        }
                    }

                    // Fill A gap (OT Afternoon for Morning Nurse)
                    if (finalA < targetA) {
                        let needed = targetA - finalA;
                        let doublePool = nurses.filter(n => newSchedule[getKey(n.id, 1, d)] === mShift.symbol);
                        doublePool = getSortedCandidates(doublePool, 'a');
                        for (let n of doublePool) {
                            if (needed > 0) {
                                if (newSchedule[getKey(n.id, 0, d)] !== '0') continue;

                                if (settings.rules.noDoubleShift && wasDoubleYesterday(n.id, d)) continue;

                                newSchedule[getKey(n.id, 0, d)] = aShift.symbol;
                                nurseStats[n.id].total++;
                                needed--;
                            }
                        }
                    }
                }

                // --- 7. Strict Limit Adjustment ---
                nurses.forEach(n => {
                    let currentWorkDays = 0;
                    for(let d=1; d<=days; d++) {
                        if(workingSymbols.includes(newSchedule[getKey(n.id, 1, d)])) currentWorkDays++;
                    }

                    let excess = currentWorkDays - settings.workDayTarget;
                    if (excess > 0) {
                        for (let d = 1; d <= days && excess > 0; d++) {
                            const k1 = getKey(n.id, 1, d);
                            const k0 = getKey(n.id, 0, d);
                            // Only flip generated shifts, not manual ones? 
                            // It's hard to distinguish manual vs auto here without more state. 
                            // Current logic assumes if we are over limit, we cut back.
                            // To be safe, we only cut M shifts that have empty OT (standard auto pattern)
                            if (newSchedule[k1] === mShift.symbol && newSchedule[k0] === '0') {
                                newSchedule[k0] = mShift.symbol; 
                                newSchedule[k1] = '0'; 
                                excess--;
                            }
                        }
                    }
                });

                setSchedule(newSchedule);
                saveAll(null, newSchedule, null, settings, customConditions);
                setIsGenerating(false);
            };

            const toggleHoliday = (day) => {
                const newHolidays = customHolidays.includes(day) 
                    ? customHolidays.filter(d => d !== day) 
                    : [...customHolidays, day];
                saveAll(null, null, newHolidays, settings, customConditions);
            };

            const cycleShift = (id, row, day) => {
                const key = getKey(id, row, day);
                const current = schedule[key] || '0';
                
                const workingSymbols = settings.shifts.map(s => s.symbol);
                const cycleTop = ['0', ...workingSymbols];
                const cycleBottom = ['0', ...workingSymbols, ...NON_WORKING_CODES];
                
                const cycleOrder = (row === 0) ? cycleTop : cycleBottom;
                const nextIndex = (cycleOrder.indexOf(current) + 1) % cycleOrder.length;
                const newSchedule = { ...schedule, [key]: cycleOrder[nextIndex] };
                saveAll(null, newSchedule, null, settings, customConditions);
            };

            const handleAddNurse = () => {
                if(!newNurse.name.trim()) {
                    alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•');
                    return;
                }
                const updated = [...nurses, { id: Date.now(), name: newNurse.name, pos: newNurse.pos || 'L1' }];
                saveAll(updated, null, null, settings, customConditions);
                setNewNurse({ name: '', pos: 'L1' });
                setShowModal(false);
            };

            const handleDeleteNurse = (id) => {
                if(confirm(`üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?`)) {
                    saveAll(nurses.filter(n => n.id !== id), null, null, settings, customConditions);
                }
            };

            const handleSaveEdit = () => {
                if (!editingNurse.name.trim()) return;
                const updatedNurses = nurses.map(n => n.id === editingNurse.id ? { ...editingNurse } : n);
                saveAll(updatedNurses, null, null, settings, customConditions);
                setEditingNurse(null);
            };

            const clearAllData = () => {
                if(confirm("‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
                    setSchedule({});
                    saveAll(null, {}, null, settings, customConditions);
                }
            };
            
            const updateSetting = (field, value) => {
                const newSettings = { ...settings, [field]: value };
                saveAll(null, null, null, newSettings, customConditions);
            };
            
            const updateRule = (rule, value) => {
                const newSettings = { ...settings, rules: { ...settings.rules, [rule]: value } };
                saveAll(null, null, null, newSettings, customConditions);
            };

            const updateShift = (index, field, value) => {
                const newShifts = [...settings.shifts];
                newShifts[index] = { ...newShifts[index], [field]: value };
                updateSetting('shifts', newShifts);
            };

            const addShift = () => {
                const newShift = { 
                    id: Date.now().toString(), 
                    symbol: '?', 
                    name: 'New', 
                    price: 0, 
                    target: 1, 
                    isNight: false, 
                    color: 'bg-gray-100 text-gray-800' 
                };
                updateSetting('shifts', [...settings.shifts, newShift]);
            };

            const removeShift = (index) => {
                if (settings.shifts.length <= 1) return;
                const newShifts = settings.shifts.filter((_, i) => i !== index);
                updateSetting('shifts', newShifts);
            };

            const exportExcel = () => {
                const wb = XLSX.utils.book_new();
                const days = Array.from({length: getDaysInMonth()}, (_, i) => i + 1);
                
                const data = [];
                data.push(['‡∏•‡∏≥‡∏î‡∏±‡∏ö', '‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', ...days, '‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£', '‡∏£‡∏ß‡∏° ‡∏ö/‡∏î', '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£', '‡∏£‡∏ß‡∏° OT', '‡∏Ñ‡πà‡∏≤ OT']);
                
                nurses.forEach((n, idx) => {
                    const s = countStats(n.id);
                    const row1 = [idx + 1, n.name, n.pos];
                    days.forEach(d => row1.push(schedule[getKey(n.id, 0, d)] || '0'));
                    row1.push(s.workDays, s.bdCount, s.bdPay, s.otCount, s.otPay);
                    
                    const row2 = ['', '', ''];
                    days.forEach(d => row2.push(schedule[getKey(n.id, 1, d)] || '0'));
                    row2.push('', '', '', '', '');

                    data.push(row1, row2);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, "Roster");
                XLSX.writeFile(wb, `Roster_v40_${currentDate.getMonth()+1}.xlsx`);
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    {/* Header */}
                    <div className="bg-white border-b border-gray-200 shadow-sm shrink-0 z-50">
                        <div className="p-3 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="bg-blue-600 text-white p-2 rounded-lg shadow-blue-200 shadow-md">
                                    <Calculator size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• <span className="text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">v40 Limit L1-L5</span></h1>
                                    <div className="flex items-center gap-2 text-sm text-gray-500">
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} className="hover:text-blue-600"><ChevronLeft size={16}/></button>
                                        <span className="font-semibold w-32 text-center">{currentDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })}</span>
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="hover:text-blue-600"><ChevronRight size={16}/></button>
                                    </div>
                                </div>
                            </div>

                            <div className="flex-1 mx-6 no-print relative">
                                <span className="absolute -top-3 left-0 text-[10px] text-gray-500 bg-white px-1">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏© / ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å</span>
                                <textarea
                                    value={customConditions}
                                    onChange={(e) => saveAll(null, null, null, settings, e.target.value)}
                                    className="w-full bg-yellow-50/50 border border-yellow-200 rounded-lg py-2 px-3 text-xs focus:ring-2 focus:ring-yellow-400 focus:outline-none resize-none h-10 transition-all focus:h-20 shadow-sm placeholder-gray-400"
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ß‡∏£‡∏î‡∏∂‡∏Å‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô, L1 ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 15..."
                                />
                            </div>

                            <div className="flex items-center gap-2 no-print">
                                <button 
                                    onClick={() => setShowSettingsModal(true)}
                                    className="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg border border-gray-200 transition-colors"
                                >
                                    <Settings size={18} />
                                    <span className="text-sm font-medium">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                                </button>

                                <button onClick={autoGenerateRoster} disabled={isGenerating} className="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1 transition-transform active:scale-95">
                                    {isGenerating ? <div className="spinner w-4 h-4 border-white"></div> : <Zap size={16} />} 
                                    <span>Auto</span>
                                </button>
                                
                                <button onClick={() => setShowModal(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1 transition-transform active:scale-95">
                                    <UserPlus size={16} /> 
                                    <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô</span>
                                </button>
                                
                                <button onClick={exportExcel} className="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1 transition-transform active:scale-95">
                                    <Download size={16} /> 
                                    <span>Excel</span>
                                </button>

                                <button onClick={clearAllData} className="bg-gray-200 hover:bg-red-500 hover:text-white text-gray-600 px-3 py-2 rounded-lg text-sm font-bold shadow-sm transition-colors">
                                    <Eraser size={16} />
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Table Area */}
                    <div className="flex-1 overflow-auto bg-gray-100 p-4">
                        <div className="bg-white rounded-lg shadow-lg border border-gray-200 overflow-x-auto max-w-full">
                            <table className="w-full min-w-max">
                                <thead>
                                    <tr>
                                        <th className="sticky-1 w-[40px]">No.</th>
                                        <th className="sticky-2 w-[160px]">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th className="sticky-3 w-[70px]">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                        {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                            const day = i + 1;
                                            const isRed = isHoliday(day);
                                            const dateObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                                            const dayName = ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'][dateObj.getDay()];
                                            return (
                                                <th 
                                                    key={i} 
                                                    onClick={() => toggleHoliday(day)}
                                                    className={`min-w-[36px] cursor-pointer hover:bg-gray-200 transition-colors ${isRed ? 'bg-red-50 text-red-600' : ''}`}
                                                >
                                                    <div className="flex flex-col items-center leading-tight">
                                                        <span className="text-[13px] font-bold">{day}</span>
                                                        <span className="text-[10px] font-normal">{dayName}</span>
                                                    </div>
                                                </th>
                                            );
                                        })}
                                        <th className="bg-blue-50 text-blue-900 border-l-2 border-blue-200 min-w-[60px] px-1">‡∏ß‡∏±‡∏ô<br/>‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</th>
                                        <th className="bg-yellow-50 text-yellow-900 border-l border-yellow-200 min-w-[60px] px-1">‡∏£‡∏ß‡∏°<br/>‡∏ö‡πà‡∏≤‡∏¢/‡∏î‡∏∂‡∏Å</th>
                                        <th className="bg-green-50 text-green-900 border-l border-green-200 min-w-[70px] px-1">‡∏£‡∏≤‡∏Ñ‡∏≤<br/>‡πÄ‡∏ß‡∏£</th>
                                        <th className="bg-orange-50 text-orange-900 border-l-2 border-orange-200 min-w-[60px] px-1">‡∏£‡∏ß‡∏°<br/>OT</th>
                                        <th className="bg-orange-100 text-orange-900 border-l border-orange-200 min-w-[70px] px-1">‡∏£‡∏≤‡∏Ñ‡∏≤<br/>({settings.otRate})</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {nurses.map((nurse, idx) => {
                                        const s = countStats(nurse.id);
                                        const isBalanced = s.workDays === settings.workDayTarget;
                                        
                                        return (
                                            <React.Fragment key={nurse.id}>
                                                <tr className="border-b-0 hover:bg-gray-50">
                                                    <td rowSpan={2} className="sticky-1 font-bold text-gray-500 bg-white">{idx + 1}</td>
                                                    <td rowSpan={2} className="sticky-2 text-left px-2 bg-white">
                                                        {editingNurse?.id === nurse.id ? (
                                                            <div className="flex flex-col gap-1 z-50 relative">
                                                                <input 
                                                                    autoFocus
                                                                    className="border rounded px-1 text-sm w-full"
                                                                    value={editingNurse.name} 
                                                                    onChange={e => setEditingNurse({...editingNurse, name: e.target.value})} 
                                                                />
                                                                <div className="flex gap-1">
                                                                    <button onClick={handleSaveEdit} className="bg-green-500 text-white text-xs px-2 rounded">Save</button>
                                                                    <button onClick={() => setEditingNurse(null)} className="bg-gray-300 text-black text-xs px-2 rounded">Cancel</button>
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div className="flex justify-between items-center group">
                                                                <span className="truncate max-w-[100px]" title={nurse.name}>{nurse.name}</span>
                                                                <div className="hidden group-hover:flex gap-1">
                                                                    <Edit2 size={12} className="cursor-pointer text-blue-500" onClick={() => setEditingNurse(nurse)}/>
                                                                    <Trash2 size={12} className="cursor-pointer text-red-500" onClick={() => handleDeleteNurse(nurse.id)}/>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td rowSpan={2} className="sticky-3 font-semibold text-gray-600 bg-white">
                                                        {editingNurse?.id === nurse.id ? (
                                                            <select 
                                                                className="border rounded text-xs w-full"
                                                                value={editingNurse.pos}
                                                                onChange={e => setEditingNurse({...editingNurse, pos: e.target.value})}
                                                            >
                                                                <option value="‡∏´‡∏ô‡∏ï.">‡∏´‡∏ô‡∏ï.</option>
                                                                <option value="L5">L5</option>
                                                                <option value="L4">L4</option>
                                                                <option value="L2">L2</option>
                                                                <option value="L1">L1</option>
                                                            </select>
                                                        ) : nurse.pos}
                                                    </td>
                                                    
                                                    {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                        const d = i + 1;
                                                        const val = schedule[getKey(nurse.id, 0, d)] || '0';
                                                        return (
                                                            <td 
                                                                key={`ot-${d}`} 
                                                                onClick={() => cycleShift(nurse.id, 0, d)}
                                                                className={`cell-hover text-xs ${val !== '0' ? 'font-bold text-red-600 bg-red-50' : 'text-gray-200'}`}
                                                            >
                                                                {val}
                                                            </td>
                                                        );
                                                    })}

                                                    <td rowSpan={2} className={`font-bold text-sm border-l-2 border-blue-200 ${isBalanced ? 'text-green-600 bg-green-50' : 'text-red-500 bg-white'}`}>
                                                        {s.workDays}
                                                        {!isBalanced && <div className="text-[9px] font-normal text-gray-400">{s.workDays - settings.workDayTarget > 0 ? `+${s.workDays - settings.workDayTarget}` : `${s.workDays - settings.workDayTarget}`}</div>}
                                                    </td>
                                                    <td rowSpan={2} className="bg-yellow-50 font-semibold border-l border-yellow-200">{s.bdCount}</td>
                                                    <td rowSpan={2} className="bg-green-50 text-gray-600 text-xs border-l border-green-200">{s.bdPay > 0 ? s.bdPay.toLocaleString() : '-'}</td>
                                                    <td rowSpan={2} className="bg-orange-50 font-bold text-orange-700 border-l-2 border-orange-200">{s.otCount}</td>
                                                    <td rowSpan={2} className="bg-orange-100 text-orange-800 font-semibold text-xs border-l border-orange-200">{s.otPay > 0 ? s.otPay.toLocaleString() : '-'}</td>
                                                </tr>

                                                <tr className="border-b border-gray-300">
                                                    {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                        const d = i + 1;
                                                        const val = schedule[getKey(nurse.id, 1, d)] || '0';
                                                        let style = STATIC_STYLES[val];
                                                        if (!style) {
                                                            const shift = getShiftBySymbol(val);
                                                            style = shift ? { label: shift.symbol, color: shift.color } : STATIC_STYLES['0'];
                                                        }

                                                        return (
                                                            <td 
                                                                key={`norm-${d}`} 
                                                                onClick={() => cycleShift(nurse.id, 1, d)}
                                                                className={`cell-hover text-xs ${style.color}`}
                                                            >
                                                                {val}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            </React.Fragment>
                                        );
                                    })}
                                </tbody>
                                <tfoot>
                                    {settings.shifts.map((shift) => (
                                        <tr key={`sum-${shift.id}`} className="bg-gray-100 font-bold text-xs text-gray-600 border-t border-gray-300">
                                            <td colSpan="3" className="sticky-1 text-right pr-2 bg-gray-100 z-40">‡∏£‡∏ß‡∏° {shift.name}</td>
                                            {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                const day = i + 1;
                                                const c = countDailyTotal(day, shift.symbol);
                                                const target = shift.target;
                                                const exactColor = shift.symbol === '‡∏ä' ? 'text-green-700 bg-green-100' : 
                                                                 (shift.symbol === '‡∏ö' ? 'text-yellow-700 bg-yellow-100' : 'text-purple-700 bg-purple-100');
                                                const statusColor = c < target ? 'text-red-600 bg-red-100' : (c > target ? 'text-blue-600 bg-blue-100' : exactColor);
                                                
                                                return <td key={i} className={statusColor}>{c || '-'}</td>;
                                            })}
                                            <td colSpan="5" className="bg-gray-200"></td>
                                        </tr>
                                    ))}
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="bg-white p-2 border-t border-gray-200 text-[11px] text-gray-600 flex justify-center gap-4 shrink-0 no-print flex-wrap">
                        <span className="font-bold">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå:</span>
                        {settings.shifts.map(s => (
                            <span key={s.id} className={`px-2 py-0.5 rounded ${s.color}`}>
                                {s.symbol} ({s.name}) {s.price > 0 ? s.price + '‡∏ø' : ''}
                            </span>
                        ))}
                        <span className="px-2 py-0.5 rounded bg-red-50 text-red-600 font-bold border border-red-200">‡∏ï‡∏±‡∏ß‡πÅ‡∏î‡∏á‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô (OT) {settings.otRate}‡∏ø</span>
                    </div>

                    {/* Modals */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100]">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-80">
                                <h3 className="text-lg font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</h3>
                                <input className="w-full border p-2 mb-2 rounded" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" value={newNurse.name} onChange={e => setNewNurse({...newNurse, name: e.target.value})} />
                                <select className="w-full border p-2 mb-4 rounded" value={newNurse.pos} onChange={e => setNewNurse({...newNurse, pos: e.target.value})}>
                                    <option value="‡∏´‡∏ô‡∏ï.">‡∏´‡∏ô‡∏ï.</option>
                                    <option value="L5">L5</option>
                                    <option value="L4">L4</option>
                                    <option value="L2">L2</option>
                                    <option value="L1">L1</option>
                                </select>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowModal(false)} className="px-4 py-2 bg-gray-200 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button onClick={handleAddNurse} className="px-4 py-2 bg-blue-600 text-white rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSettingsModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl w-[600px] max-w-full max-h-[90vh] overflow-hidden flex flex-col">
                                <div className="flex justify-between items-center p-4 border-b">
                                    <div className="flex items-center gap-2">
                                        <Settings className="text-gray-700" size={20} />
                                        <h2 className="text-lg font-bold text-gray-800">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
                                    </div>
                                    <button onClick={() => setShowSettingsModal(false)} className="text-gray-400 hover:text-red-500">
                                        <X size={20} />
                                    </button>
                                </div>

                                <div className="p-6 overflow-y-auto space-y-6 bg-gray-50 flex-1">
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <h3 className="font-bold text-blue-900 text-sm">4. ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (Work Days)</h3>
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm text-blue-800">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</span>
                                                <input 
                                                    type="number" 
                                                    value={settings.workDayTarget}
                                                    onChange={(e) => updateSetting('workDayTarget', parseInt(e.target.value) || 0)}
                                                    className="w-16 border border-blue-300 rounded px-2 py-1 text-center font-bold text-blue-900 focus:ring-2 focus:ring-blue-500 outline-none"
                                                />
                                            </div>
                                        </div>
                                        <p className="text-xs text-blue-600">* ‡∏´‡∏≤‡∏Å‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£"</p>
                                    </div>

                                    <div>
                                        <div className="flex justify-between items-center mb-2">
                                            <h3 className="font-bold text-gray-700">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏∞‡∏á‡∏≤‡∏ô (Shifts)</h3>
                                            <button onClick={addShift} className="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded border border-indigo-200 hover:bg-indigo-100 flex items-center gap-1">
                                                <Plus size={12}/> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                                            </button>
                                        </div>
                                        <div className="bg-white border rounded-lg overflow-hidden">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-gray-100 text-gray-600 font-medium text-xs uppercase">
                                                    <tr>
                                                        <th className="px-3 py-2">‡∏™‡∏µ</th>
                                                        <th className="px-3 py-2">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</th>
                                                        <th className="px-3 py-2">‡∏ä‡∏∑‡πà‡∏≠</th>
                                                        <th className="px-3 py-2 w-20">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                                        <th className="px-3 py-2 w-16">‡πÄ‡∏õ‡πâ‡∏≤</th>
                                                        <th className="px-3 py-2 text-center">‡∏î‡∏∂‡∏Å?</th>
                                                        <th className="px-3 py-2"></th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {settings.shifts.map((shift, idx) => (
                                                        <tr key={shift.id}>
                                                            <td className="px-3 py-2">
                                                                <div className={`w-6 h-6 rounded ${shift.color} border border-gray-200 shadow-sm`}></div>
                                                            </td>
                                                            <td className="px-3 py-2">
                                                                <input 
                                                                    className="w-10 border rounded px-1 py-0.5 text-center font-bold"
                                                                    value={shift.symbol}
                                                                    onChange={(e) => updateShift(idx, 'symbol', e.target.value)}
                                                                />
                                                            </td>
                                                            <td className="px-3 py-2">
                                                                <input 
                                                                    className="w-full border rounded px-2 py-0.5"
                                                                    value={shift.name}
                                                                    onChange={(e) => updateShift(idx, 'name', e.target.value)}
                                                                />
                                                            </td>
                                                            <td className="px-3 py-2">
                                                                <input 
                                                                    type="number"
                                                                    className="w-16 border rounded px-1 py-0.5 text-right"
                                                                    value={shift.price}
                                                                    onChange={(e) => updateShift(idx, 'price', parseInt(e.target.value) || 0)}
                                                                />
                                                            </td>
                                                            <td className="px-3 py-2">
                                                                <input 
                                                                    type="number"
                                                                    className="w-12 border rounded px-1 py-0.5 text-center text-blue-600 font-bold"
                                                                    value={shift.target}
                                                                    onChange={(e) => updateShift(idx, 'target', parseInt(e.target.value) || 0)}
                                                                />
                                                            </td>
                                                            <td className="px-3 py-2 text-center">
                                                                <input 
                                                                    type="checkbox"
                                                                    className="w-4 h-4 rounded text-blue-600"
                                                                    checked={shift.isNight}
                                                                    onChange={(e) => updateShift(idx, 'isNight', e.target.checked)}
                                                                />
                                                            </td>
                                                            <td className="px-3 py-2 text-right">
                                                                <button onClick={() => removeShift(idx)} className="text-gray-400 hover:text-red-500">
                                                                    <Trash2 size={16} />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-6">
                                        <div>
                                            <h3 className="font-bold text-gray-700 mb-2">2. ‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô</h3>
                                            <div className="bg-white p-4 rounded-lg border border-gray-200">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-sm text-gray-600">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£ OT</span>
                                                    <div className="relative">
                                                        <input 
                                                            type="number" 
                                                            value={settings.otRate}
                                                            onChange={(e) => updateSetting('otRate', parseInt(e.target.value) || 0)}
                                                            className="w-24 border border-gray-300 rounded px-2 py-1 pr-6 text-right font-medium"
                                                        />
                                                        <span className="absolute right-2 top-1.5 text-xs text-gray-400">‡∏ø</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div>
                                            <h3 className="font-bold text-gray-700 mb-2">3. ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å</h3>
                                            <div className="bg-white p-4 rounded-lg border border-gray-200 space-y-3">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-sm text-gray-600">‡∏´‡πâ‡∏≤‡∏° ‡∏î‡∏∂‡∏Å -> ‡πÄ‡∏ä‡πâ‡∏≤</span>
                                                    <ToggleSwitch 
                                                        checked={settings.rules.noNightToMorning} 
                                                        onChange={(val) => updateRule('noNightToMorning', val)} 
                                                    />
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <span className="text-sm text-gray-600">‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏á‡πÄ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô</span>
                                                    <ToggleSwitch 
                                                        checked={settings.rules.noDoubleShift} 
                                                        onChange={(val) => updateRule('noDoubleShift', val)} 
                                                    />
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <span className="text-sm text-gray-600">‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏ß‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô</span>
                                                    <ToggleSwitch 
                                                        checked={settings.rules.balanceShifts} 
                                                        onChange={(val) => updateRule('balanceShifts', val)} 
                                                    />
                                                </div>
                                                <div className="flex justify-between items-center border-t pt-2 mt-2">
                                                    <span className="text-sm text-red-600 font-medium">L1-L5 ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 7 ‡∏ß‡∏±‡∏ô</span>
                                                    <ToggleSwitch 
                                                        checked={settings.rules.limitSevenDays} 
                                                        onChange={(val) => updateRule('limitSevenDays', val)} 
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <div className="p-4 border-t bg-gray-50 flex justify-end">
                                    <button 
                                        onClick={() => setShowSettingsModal(false)}
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold shadow-sm transition-transform active:scale-95"
                                    >
                                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<RosterApp />);
    </script>
</body>
</html>
