
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• v40 - Full Settings UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "xlsx": "https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            margin: 0;
            padding: 0;
            background-color: #f8fafc;
        }
        
        .overflow-x-auto::-webkit-scrollbar { height: 12px; }
        .overflow-x-auto::-webkit-scrollbar-track { background: #f1f5f9; }
        .overflow-x-auto::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 6px; 
            border: 2px solid #f1f5f9; 
        }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        table { 
            border-spacing: 0;
            width: 100%;
            border-collapse: separate;
        }
        
        th, td {
            white-space: nowrap;
            text-align: center;
            border: 1px solid #e2e8f0;
            height: 32px;
            padding: 0 4px;
            font-size: 13px;
            box-sizing: border-box;
        }

        /* Sticky Columns */
        .sticky-1 { position: sticky; left: 0; width: 40px; min-width: 40px; background-color: white; z-index: 35; border-right: 1px solid #e2e8f0; }
        .sticky-2 { position: sticky; left: 40px; width: 160px; min-width: 160px; background-color: white; z-index: 35; border-right: 1px solid #e2e8f0; }
        .sticky-3 { position: sticky; left: 200px; width: 70px; min-width: 70px; background-color: white; border-right: 3px solid #cbd5e1; box-shadow: 4px 0 6px -2px rgba(0, 0, 0, 0.1); z-index: 35; }
        
        thead tr th { position: sticky; top: 0; z-index: 40; background-color: #f1f5f9; color: #334155; height: 50px; }
        thead tr th.sticky-1, thead tr th.sticky-2, thead tr th.sticky-3 { z-index: 50; background-color: #f8fafc; }

        .cell-hover:hover { filter: brightness(0.95); cursor: pointer; transform: scale(1.1); transition: transform 0.1s; z-index: 10; position: relative; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .header-hover:hover { background-color: #e2e8f0; cursor: pointer; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }

        @media print {
            .no-print { display: none !important; }
            table { font-size: 10px; width: 100%; }
            th, td { height: 20px; padding: 0; border: 1px solid #000; }
            .sticky-1, .sticky-2, .sticky-3 { position: static; border-right: 1px solid #000; box-shadow: none; width: auto; min-width: auto; }
            body { background-color: white; }
            .overflow-x-auto { overflow: visible; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Download, Calculator, UserPlus, Trash2, ChevronLeft, ChevronRight, Zap, Eraser, Settings, Edit2, Save, X, Plus, AlertCircle } from 'lucide-react';
        import * as XLSX from 'xlsx';

        // --- CONSTANTS & INITIAL DATA ---
        const INITIAL_NURSES = [
            { id: 1, name: "‡∏ô‡∏≤‡∏á‡∏™‡∏á‡∏ö ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏ò‡∏£‡∏£‡∏°", pos: "‡∏´‡∏ô‡∏ï." },
            { id: 2, name: "‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏©‡∏ì‡∏∏‡∏Å‡∏£‡∏ì‡πå ‡πÇ‡∏≠‡∏¢‡∏≤", pos: "L5" },
            { id: 3, name: "‡∏ô.‡∏™.‡∏à‡∏≤‡∏£‡∏∏‡∏û‡∏£ ‡∏®‡∏£‡∏µ‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏û‡∏ö‡∏π‡∏•‡∏¢‡πå", pos: "L5" },
            { id: 4, name: "‡∏ô.‡∏™.‡πÄ‡∏Ç‡∏°‡∏£‡∏∏‡∏à‡∏¥ ‡∏¢‡∏≤‡∏™‡∏ö‡∏π‡πà", pos: "L4" },
            { id: 5, name: "‡∏ô.‡∏™.‡∏õ‡∏≤‡∏à‡∏≤‡∏£‡∏µ‡∏¢‡πå ‡∏ô‡∏¥‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏õ‡∏£‡∏∞‡∏®‡∏≤‡∏™‡∏ô‡πå", pos: "L4" },
            { id: 6, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏ô‡∏¥‡∏™‡∏≤ ‡∏™‡∏∏‡∏Ç‡πÄ‡∏≠‡∏¥‡∏ö", pos: "L4" },
            { id: 7, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏†‡∏≤‡∏ß‡∏î‡∏µ ‡∏¢‡∏°‡∏ô‡πâ‡∏≠‡∏¢", pos: "L4" },
            { id: 8, name: "‡∏ô.‡∏™.‡∏ó‡∏¥‡∏û‡∏õ‡∏†‡∏≤ ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏ò‡∏µ", pos: "L2" },
            { id: 9, name: "‡∏ô.‡∏™.‡∏™‡∏∏‡∏ô‡∏±‡∏ô‡∏ó‡∏£‡∏≤ ‡πÄ‡∏Å‡∏ï‡∏∏‡∏û‡∏á‡∏©‡πå", pos: "L2" },
            { id: 10, name: "‡∏ô.‡∏™.‡∏™‡∏¥‡∏£‡∏¥‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏ö‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê", pos: "L1" }
        ];

        const DEFAULT_RULES = [
            "‡∏´‡πâ‡∏≤‡∏°‡∏î‡∏∂‡∏Å -> ‡πÄ‡∏ä‡πâ‡∏≤",
            "‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏á‡πÄ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô",
            "‡πÄ‡∏Å‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏ß‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô",
            "L1-L5 ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 7 ‡∏ß‡∏±‡∏ô",
            "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£‡πÄ‡∏ä‡πâ‡∏≤ 4 ‡∏Ñ‡∏ô ‡πÄ‡∏ß‡∏£‡∏ö‡πà‡∏≤‡∏¢ 3 ‡∏Ñ‡∏ô ‡πÄ‡∏ß‡∏£‡∏î‡∏∂‡∏Å 2 ‡∏Ñ‡∏ô",
            "‡∏´‡πâ‡∏≤‡∏° ‡πÄ‡∏ä‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏¢ ‡∏™‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î"
        ];

        const SHIFT_METADATA = {
            '0':      { label: '0',      color: 'bg-white text-red-300' },
            '‡∏ä':      { label: '‡∏ä',      color: 'bg-green-100 text-green-800 font-bold' },
            '‡∏ö':      { label: '‡∏ö',      color: 'bg-yellow-100 text-yellow-800 font-bold' },
            '‡∏î':      { label: '‡∏î',      color: 'bg-purple-100 text-purple-800 font-bold' },
            'Va':     { label: 'Va',     color: 'bg-blue-100 text-blue-800 font-bold text-xs' },
            '‡∏õ‡∏ä':     { label: '‡∏õ‡∏ä',     color: 'bg-orange-100 text-orange-800 font-bold text-xs' },
            '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢': { label: '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', color: 'bg-red-100 text-red-800 font-bold text-[10px]' },
            '‡∏•‡∏≤‡∏Å‡∏¥‡∏à':  { label: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à',  color: 'bg-indigo-100 text-indigo-800 font-bold text-[10px]' }
        };

        const NON_WORKING_CODES = ['Va', '‡∏õ‡∏ä','‡∏•‡∏≤‡∏Å‡∏¥‡∏à', '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'];
        const CYCLE_TOP = ['0', '‡∏ä', '‡∏ö', '‡∏î']; 
        const CYCLE_BOTTOM = ['0', '‡∏ä', '‡∏ö', '‡∏î', ...NON_WORKING_CODES];

        export default function RosterApp() {
            // --- STATE ---
            const [currentDate, setCurrentDate] = useState(new Date());
            const [nurses, setNurses] = useState(INITIAL_NURSES);
            const [schedule, setSchedule] = useState({});
            const [customHolidays, setCustomHolidays] = useState([]);
            
            // Settings State
            const [config, setConfig] = useState({
                workDayLimit: 20,
                otRate: 800,
                shiftRates: { '‡∏ä': 0, '‡∏ö': 360, '‡∏î': 360 }, // Rate per shift
                shiftTargets: { '‡∏ä': 5, '‡∏ö': 3, '‡∏î': 2 }, // Target staff per shift
                rules: DEFAULT_RULES
            });

            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [showAddNurseModal, setShowAddNurseModal] = useState(false);
            const [newNurse, setNewNurse] = useState({ name: '', pos: 'L1' });
            const [editingNurse, setEditingNurse] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);

            // --- LOCAL STORAGE ---
            useEffect(() => {
                const savedData = localStorage.getItem('roster_data_v40');
                const savedNurses = localStorage.getItem('roster_nurses_v40');
                const savedHolidays = localStorage.getItem('roster_holidays_v40');
                const savedConfig = localStorage.getItem('roster_config_v40');
                
                if (savedData) setSchedule(JSON.parse(savedData));
                if (savedNurses) setNurses(JSON.parse(savedNurses));
                if (savedHolidays) setCustomHolidays(JSON.parse(savedHolidays));
                if (savedConfig) setConfig(JSON.parse(savedConfig));
            }, []);

            const saveAll = (updatedNurses, updatedSchedule, updatedHolidays, updatedConfig) => {
                if(updatedNurses) {
                    setNurses(updatedNurses);
                    localStorage.setItem('roster_nurses_v40', JSON.stringify(updatedNurses));
                }
                if(updatedSchedule) {
                    setSchedule(updatedSchedule);
                    localStorage.setItem('roster_data_v40', JSON.stringify(updatedSchedule));
                }
                if(updatedHolidays) {
                    setCustomHolidays(updatedHolidays);
                    localStorage.setItem('roster_holidays_v40', JSON.stringify(updatedHolidays));
                }
                if(updatedConfig) {
                    setConfig(updatedConfig);
                    localStorage.setItem('roster_config_v40', JSON.stringify(updatedConfig));
                }
            };

            // --- HELPERS ---
            const getDaysInMonth = () => new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const getKey = (id, row, day) => `${id}-${row}-${day}`;
            const isHN = (n) => n.pos && n.pos.includes('‡∏´‡∏ô‡∏ï');
            
            const isHoliday = (day) => {
                const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                return [0, 6].includes(d.getDay()) || customHolidays.includes(day);
            };

            // --- CALCULATION LOGIC ---
            const countStats = (nurseId) => {
                const days = getDaysInMonth();
                let otCount = 0;
                let bdCount = 0;
                let bdPay = 0;
                let workDays = 0;
                
                for(let d=1; d<=days; d++) {
                    const valTop = schedule[getKey(nurseId, 0, d)] || '0';
                    const valBot = schedule[getKey(nurseId, 1, d)] || '0';
                    
                    // OT Calculation (Row 0)
                    if (['‡∏ä','‡∏ö','‡∏î'].includes(valTop)) {
                        otCount++;
                    }

                    // Work Day & BD Pay (Row 1)
                    if (['‡∏ä','‡∏ö','‡∏î'].includes(valBot)) {
                        workDays++;
                        // Calculate specific pay based on shift type
                        bdPay += (config.shiftRates[valBot] || 0);
                        if (['‡∏ö','‡∏î'].includes(valBot)) bdCount++;
                    }
                }

                return {
                    otCount,
                    otPay: otCount * config.otRate,
                    bdCount,
                    bdPay,
                    workDays
                };
            };

            const countDailyTotal = (day, type, scheduleToUse = schedule) => {
                let count = 0;
                nurses.forEach(n => {
                    if(scheduleToUse[getKey(n.id, 0, day)] === type) count++;
                    if(scheduleToUse[getKey(n.id, 1, day)] === type) count++;
                });
                return count;
            };

            // --- AUTO GENERATE (Uses Config Targets) ---
            const autoGenerateRoster = async () => {
                const confirmMsg = `üéØ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£ AI?\n\n‡∏Å‡∏é: ${config.rules.join(', ')}`;
                if (!confirm(confirmMsg)) return;

                setIsGenerating(true);
                await new Promise(resolve => setTimeout(resolve, 100));

                const days = getDaysInMonth();
                let newSchedule = { ...schedule };
                
                // Clear shifts
                nurses.forEach(n => {
                    for(let d=1; d<=days; d++) {
                        if(['‡∏ä','‡∏ö','‡∏î'].includes(newSchedule[getKey(n.id, 1, d)])) newSchedule[getKey(n.id, 1, d)] = '0';
                        if(['‡∏ä','‡∏ö','‡∏î'].includes(newSchedule[getKey(n.id, 0, d)])) newSchedule[getKey(n.id, 0, d)] = '0';
                    }
                });

                let nurseStats = {};
                nurses.forEach(n => nurseStats[n.id] = { m: 0, a: 0, n: 0, total: 0 });

                // Scoring AI
                const getAICandidates = (candidates, shiftType) => {
                    return [...candidates].sort((a, b) => {
                        const statsA = nurseStats[a.id];
                        const statsB = nurseStats[b.id];
                        const scoreA = (statsA[shiftType] * 100) + statsA.total + (Math.random() * 0.5);
                        const scoreB = (statsB[shiftType] * 100) + statsB.total + (Math.random() * 0.5);
                        return scoreA - scoreB;
                    });
                };

                const getConsecutiveDays = (scheduleData, nurseId, currentDay) => {
                    let count = 0;
                    for(let i = currentDay - 1; i >= 1; i--) {
                        const worked = ['‡∏ä','‡∏ö','‡∏î'].includes(scheduleData[getKey(nurseId, 0, i)]) || ['‡∏ä','‡∏ö','‡∏î'].includes(scheduleData[getKey(nurseId, 1, i)]);
                        if(worked) count++; else break;
                    }
                    return count;
                };

                for (let d = 1; d <= days; d++) {
                    const isRed = isHoliday(d);
                    const targetM = config.shiftTargets['‡∏ä'] || 5;
                    const targetA = config.shiftTargets['‡∏ö'] || 3;
                    const targetN = config.shiftTargets['‡∏î'] || 2;

                    // 1. Pre-Assign HN
                    const hn = nurses.find(isHN);
                    let hnWorked = false;
                    if (hn) {
                        if (!isRed && !NON_WORKING_CODES.includes(newSchedule[getKey(hn.id, 1, d)])) {
                            if (getConsecutiveDays(newSchedule, hn.id, d) < 7) { // Max 7 rule
                                newSchedule[getKey(hn.id, 1, d)] = '‡∏ä';
                                nurseStats[hn.id].m++;
                                nurseStats[hn.id].total++;
                                hnWorked = true;
                            }
                        }
                    }

                    // 2. Identify Available
                    let availableIds = [];
                    nurses.forEach(n => {
                        if (n.id === hn?.id) return;
                        const k1 = getKey(n.id, 1, d);
                        if (NON_WORKING_CODES.includes(newSchedule[k1])) return;
                        if (d > 1 && newSchedule[getKey(n.id, 1, d-1)] === '‡∏î') return; // No N->M
                        if (getConsecutiveDays(newSchedule, n.id, d) >= 7) return; // Max 7
                        availableIds.push(n.id);
                    });

                    let candidates = nurses.filter(n => availableIds.includes(n.id));
                    let assignedToday = [];

                    // 3. Assign N
                    let nightPool = getAICandidates(candidates, 'n');
                    let countN = 0;
                    for (let n of nightPool) {
                        if (countN < targetN) {
                            newSchedule[getKey(n.id, 1, d)] = '‡∏î';
                            assignedToday.push(n.id);
                            nurseStats[n.id].n++;
                            nurseStats[n.id].total++;
                            countN++;
                        }
                    }
                    candidates = candidates.filter(n => !assignedToday.includes(n.id));

                    // 4. Assign A
                    let afternoonPool = getAICandidates(candidates, 'a');
                    let countA = 0;
                    for (let n of afternoonPool) {
                        if (countA < targetA) {
                            newSchedule[getKey(n.id, 1, d)] = '‡∏ö';
                            assignedToday.push(n.id);
                            nurseStats[n.id].a++;
                            nurseStats[n.id].total++;
                            countA++;
                        }
                    }
                    candidates = candidates.filter(n => !assignedToday.includes(n.id));

                    // 5. Assign M
                    let morningPool = getAICandidates(candidates, 'm');
                    let countM = hnWorked ? 1 : 0;
                    for (let n of morningPool) {
                        if (countM < targetM) {
                            newSchedule[getKey(n.id, 1, d)] = '‡∏ä';
                            assignedToday.push(n.id);
                            nurseStats[n.id].m++;
                            nurseStats[n.id].total++;
                            countM++;
                        }
                    }

                    // 6. Fill Gaps with OT (Simplified Logic)
                     if (countM < targetM) {
                        let needed = targetM - countM;
                        let otPool = nurses.filter(n => newSchedule[getKey(n.id, 1, d)] === '‡∏ö'); // OT ‡πÄ‡∏ä‡πâ‡∏≤ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ö‡πà‡∏≤‡∏¢
                        for (let n of otPool) {
                            if (needed > 0) {
                                newSchedule[getKey(n.id, 0, d)] = '‡∏ä';
                                nurseStats[n.id].total++;
                                needed--;
                            }
                        }
                    }
                }

                // 7. Limit Adjustment (Simple Flip)
                nurses.forEach(n => {
                    let currentWorkDays = 0;
                    for(let d=1; d<=days; d++) if(['‡∏ä','‡∏ö','‡∏î'].includes(newSchedule[getKey(n.id, 1, d)])) currentWorkDays++;
                    let excess = currentWorkDays - config.workDayLimit;
                    
                    if (excess > 0) {
                        let flippable = [];
                        for (let d = 1; d <= days; d++) {
                             if (newSchedule[getKey(n.id, 1, d)] === '‡∏ä' && newSchedule[getKey(n.id, 0, d)] === '0') flippable.push(d);
                        }
                        flippable.sort(() => Math.random() - 0.5);
                        for (let i = 0; i < excess && i < flippable.length; i++) {
                            const d = flippable[i];
                            newSchedule[getKey(n.id, 0, d)] = '‡∏ä';
                            newSchedule[getKey(n.id, 1, d)] = '0';
                        }
                    }
                });

                setSchedule(newSchedule);
                saveAll(null, newSchedule, null, null);
                setIsGenerating(false);
            };

            // --- EVENT HANDLERS ---
            const toggleHoliday = (day) => {
                const newHolidays = customHolidays.includes(day) 
                    ? customHolidays.filter(d => d !== day) 
                    : [...customHolidays, day];
                saveAll(null, null, newHolidays, null);
            };

            const cycleShift = (id, row, day) => {
                const key = getKey(id, row, day);
                const current = schedule[key] || '0';
                const cycleOrder = (row === 0) ? CYCLE_TOP : CYCLE_BOTTOM;
                const nextIndex = (cycleOrder.indexOf(current) + 1) % cycleOrder.length;
                const newSchedule = { ...schedule, [key]: cycleOrder[nextIndex] };
                saveAll(null, newSchedule, null, null);
            };

            // Nurse Management
            const handleAddNurse = () => {
                if(!newNurse.name.trim()) return alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•');
                const updated = [...nurses, { id: Date.now(), name: newNurse.name, pos: newNurse.pos || 'L1' }];
                saveAll(updated, null, null, null);
                setNewNurse({ name: '', pos: 'L1' });
                setShowAddNurseModal(false);
            };
            const handleDeleteNurse = (id) => {
                if(confirm(`üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?`)) saveAll(nurses.filter(n => n.id !== id), null, null, null);
            };
            const handleSaveEdit = () => {
                if (!editingNurse.name.trim()) return;
                const updatedNurses = nurses.map(n => n.id === editingNurse.id ? { ...editingNurse } : n);
                saveAll(updatedNurses, null, null, null);
                setEditingNurse(null);
            };

            const clearAllData = () => {
                if(confirm("‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
                    setSchedule({});
                    saveAll(null, {}, null, null);
                }
            };

            const exportExcel = () => {
                const wb = XLSX.utils.book_new();
                const days = Array.from({length: getDaysInMonth()}, (_, i) => i + 1);
                const data = [];
                data.push(['‡∏•‡∏≥‡∏î‡∏±‡∏ö', '‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', ...days, '‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£', '‡∏£‡∏ß‡∏° ‡∏ö/‡∏î', '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£', '‡∏£‡∏ß‡∏° OT', '‡∏Ñ‡πà‡∏≤ OT']);
                
                nurses.forEach((n, idx) => {
                    const s = countStats(n.id);
                    const row1 = [idx + 1, n.name, n.pos];
                    days.forEach(d => row1.push(schedule[getKey(n.id, 0, d)] || '0'));
                    row1.push(s.workDays, s.bdCount, s.bdPay, s.otCount, s.otPay);
                    const row2 = ['', '', ''];
                    days.forEach(d => row2.push(schedule[getKey(n.id, 1, d)] || '0'));
                    row2.push('', '', '', '', '');
                    data.push(row1, row2);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, "Roster");
                XLSX.writeFile(wb, `Roster_v40_${currentDate.getMonth()+1}.xlsx`);
            };

            // --- SUB-COMPONENT: SETTINGS MODAL ---
            const SettingsModal = () => {
                // Local state for editing inside modal
                const [localConfig, setLocalConfig] = useState(JSON.parse(JSON.stringify(config)));
                const [newRule, setNewRule] = useState('');

                const handleSaveSettings = () => {
                    saveAll(null, null, null, localConfig);
                    setShowSettingsModal(false);
                };

                const updateShiftRate = (key, val) => {
                    setLocalConfig(prev => ({...prev, shiftRates: {...prev.shiftRates, [key]: parseInt(val) || 0}}));
                };

                const updateShiftTarget = (key, val) => {
                    setLocalConfig(prev => ({...prev, shiftTargets: {...prev.shiftTargets, [key]: parseInt(val) || 0}}));
                };

                const addRule = () => {
                    if (newRule.trim()) {
                        setLocalConfig(prev => ({...prev, rules: [...prev.rules, newRule.trim()]}));
                        setNewRule('');
                    }
                };

                const removeRule = (index) => {
                    setLocalConfig(prev => ({...prev, rules: prev.rules.filter((_, i) => i !== index)}));
                };

                return (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] backdrop-blur-sm">
                        <div className="bg-white rounded-xl shadow-2xl w-[600px] max-h-[90vh] overflow-y-auto flex flex-col">
                            {/* Header */}
                            <div className="flex justify-between items-center p-4 border-b">
                                <h2 className="text-xl font-bold text-gray-800">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£</h2>
                                <button onClick={() => setShowSettingsModal(false)} className="text-gray-400 hover:text-gray-600">
                                    <X size={24} />
                                </button>
                            </div>

                            <div className="p-6 space-y-6">
                                {/* 1. Target Workdays */}
                                <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                    <h3 className="font-bold text-blue-800 mb-2">1. ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</h3>
                                    <div className="flex items-center gap-4">
                                        <div className="flex items-center gap-2">
                                            <span className="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</span>
                                            <input 
                                                type="number" 
                                                value={localConfig.workDayLimit} 
                                                onChange={(e) => setLocalConfig({...localConfig, workDayLimit: parseInt(e.target.value) || 0})}
                                                className="w-20 border rounded p-1 text-center font-bold"
                                            />
                                        </div>
                                        <div className="text-xs text-gray-500">* ‡∏´‡∏≤‡∏Å‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£"</div>
                                    </div>
                                    <div className="text-sm mt-1 text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: {getDaysInMonth()} ‡∏ß‡∏±‡∏ô</div>
                                </div>

                                {/* 2. Shift Details */}
                                <div className="bg-green-50 p-4 rounded-lg border border-green-100">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-bold text-green-800">2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ß‡∏£ (Shifts)</h3>
                                        <button className="text-xs bg-green-600 text-white px-2 py-1 rounded flex items-center gap-1 opacity-50 cursor-not-allowed" title="‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô‡∏ô‡∏µ‡πâ">
                                            <Plus size={12}/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏£
                                        </button>
                                    </div>
                                    <div className="bg-white rounded border overflow-hidden">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="py-2">‡∏™‡∏µ</th>
                                                    <th className="py-2">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</th>
                                                    <th className="py-2">‡∏ä‡∏∑‡πà‡∏≠</th>
                                                    <th className="py-2">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                                                    <th className="py-2">‡πÄ‡∏õ‡πâ‡∏≤ (‡∏Ñ‡∏ô)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {[
                                                    {key: '‡∏ä', name: '‡πÄ‡∏ä‡πâ‡∏≤', color: 'bg-green-100'},
                                                    {key: '‡∏ö', name: '‡∏ö‡πà‡∏≤‡∏¢', color: 'bg-yellow-100'},
                                                    {key: '‡∏î', name: '‡∏î‡∏∂‡∏Å', color: 'bg-purple-100'}
                                                ].map(s => (
                                                    <tr key={s.key} className="border-t">
                                                        <td className="p-2"><div className={`w-6 h-6 rounded ${s.color} mx-auto border`}></div></td>
                                                        <td className="p-2 font-bold">{s.key}</td>
                                                        <td className="p-2 w-full text-left">
                                                            <input type="text" value={s.name} disabled className="w-full p-1 border rounded bg-gray-50"/>
                                                        </td>
                                                        <td className="p-2">
                                                            <input 
                                                                type="number" 
                                                                className="w-20 p-1 border rounded text-right"
                                                                value={localConfig.shiftRates[s.key]}
                                                                onChange={(e) => updateShiftRate(s.key, e.target.value)}
                                                            />
                                                        </td>
                                                        <td className="p-2">
                                                            <input 
                                                                type="number" 
                                                                className="w-16 p-1 border rounded text-center"
                                                                value={localConfig.shiftTargets[s.key]}
                                                                onChange={(e) => updateShiftTarget(s.key, e.target.value)}
                                                            />
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* 3. Compensation */}
                                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                                    <h3 className="font-bold text-yellow-800 mb-2">3. ‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô</h3>
                                    <div className="flex items-center gap-4">
                                        <div className="flex items-center gap-2">
                                            <span className="text-sm font-semibold">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£ OT:</span>
                                            <input 
                                                type="number" 
                                                value={localConfig.otRate}
                                                onChange={(e) => setLocalConfig({...localConfig, otRate: parseInt(e.target.value) || 0})}
                                                className="w-24 border rounded p-1 text-right font-bold"
                                            />
                                            <span className="text-sm">‡∏ö‡∏≤‡∏ó</span>
                                        </div>
                                    </div>
                                    <div className="text-xs text-gray-500 mt-2">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£‡∏ö‡πà‡∏≤‡∏¢/‡∏î‡∏∂‡∏Å: ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>
                                </div>

                                {/* 4. Rules */}
                                <div className="bg-red-50 p-4 rounded-lg border border-red-100">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-bold text-red-800">4. ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Auto)</h3>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                value={newRule} 
                                                onChange={(e) => setNewRule(e.target.value)}
                                                placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏é..."
                                                className="text-xs border rounded p-1 w-32"
                                                onKeyPress={(e) => e.key === 'Enter' && addRule()}
                                            />
                                            <button onClick={addRule} className="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">
                                                + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏é
                                            </button>
                                        </div>
                                    </div>
                                    <div className="space-y-2 max-h-40 overflow-y-auto">
                                        {localConfig.rules.map((rule, idx) => (
                                            <div key={idx} className="bg-white p-2 rounded border flex justify-between items-center shadow-sm">
                                                <span className="text-sm text-gray-700">{rule}</span>
                                                <button onClick={() => removeRule(idx)} className="text-red-400 hover:text-red-600">
                                                    <Trash2 size={14} />
                                                </button>
                                            </div>
                                        ))}
                                        {localConfig.rules.length === 0 && <div className="text-center text-gray-400 text-xs py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏é</div>}
                                    </div>
                                </div>
                            </div>

                            {/* Footer Buttons */}
                            <div className="p-4 border-t bg-gray-50 flex justify-end gap-3 rounded-b-xl">
                                <button onClick={() => setShowSettingsModal(false)} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                                <button onClick={handleSaveSettings} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold flex items-center gap-2">
                                    <Save size={18} /> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    {/* Header */}
                    <div className="bg-white border-b border-gray-200 shadow-sm shrink-0 z-50">
                        <div className="p-3 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="bg-blue-600 text-white p-2 rounded-lg shadow-blue-200 shadow-md">
                                    <Calculator size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• <span className="text-xs text-orange-600 bg-orange-50 px-2 py-0.5 rounded-full">v40 Settings UI</span></h1>
                                    <div className="flex items-center gap-2 text-sm text-gray-500">
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} className="hover:text-blue-600"><ChevronLeft size={16}/></button>
                                        <span className="font-semibold w-32 text-center">{currentDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })}</span>
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="hover:text-blue-600"><ChevronRight size={16}/></button>
                                    </div>
                                </div>
                            </div>

                            {/* Toolbar */}
                            <div className="flex items-center gap-2 no-print">
                                <div className="flex items-center gap-2 bg-yellow-50 px-3 py-1.5 rounded-lg border border-yellow-200 text-yellow-800 text-xs font-medium mr-4">
                                    <AlertCircle size={14} />
                                    <span>‡πÄ‡∏õ‡πâ‡∏≤: {config.workDayLimit} ‡∏ß‡∏±‡∏ô | OT: {config.otRate}‡∏ø</span>
                                </div>

                                <button onClick={() => setShowSettingsModal(true)} className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1">
                                    <Settings size={16} /> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                                </button>

                                <button onClick={autoGenerateRoster} disabled={isGenerating} className="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1 transition-transform active:scale-95">
                                    {isGenerating ? <div className="spinner w-4 h-4 border-white"></div> : <Zap size={16} />} 
                                    <span>Auto</span>
                                </button>
                                
                                <button onClick={() => setShowAddNurseModal(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1 transition-transform active:scale-95">
                                    <UserPlus size={16} /> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô
                                </button>
                                
                                <button onClick={exportExcel} className="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-1 transition-transform active:scale-95">
                                    <Download size={16} /> Excel
                                </button>

                                <button onClick={clearAllData} className="bg-gray-200 hover:bg-red-500 hover:text-white text-gray-600 px-3 py-2 rounded-lg text-sm font-bold shadow-sm transition-colors">
                                    <Eraser size={16} />
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Main Table */}
                    <div className="flex-1 overflow-auto bg-gray-100 p-4">
                        <div className="bg-white rounded-lg shadow-lg border border-gray-200 overflow-x-auto max-w-full">
                            <table className="w-full min-w-max">
                                <thead>
                                    <tr>
                                        <th className="sticky-1 w-[40px]">No.</th>
                                        <th className="sticky-2 w-[160px]">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th className="sticky-3 w-[70px]">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                        {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                            const day = i + 1;
                                            const isRed = isHoliday(day);
                                            const dateObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                                            const dayName = ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'][dateObj.getDay()];
                                            return (
                                                <th key={i} onClick={() => toggleHoliday(day)} className={`min-w-[36px] cursor-pointer hover:bg-gray-200 transition-colors ${isRed ? 'bg-red-50 text-red-600' : ''}`}>
                                                    <div className="flex flex-col items-center leading-tight">
                                                        <span className="text-[13px] font-bold">{day}</span>
                                                        <span className="text-[10px] font-normal">{dayName}</span>
                                                    </div>
                                                </th>
                                            );
                                        })}
                                        <th className="bg-blue-50 text-blue-900 border-l-2 border-blue-200 min-w-[60px] px-1">‡∏ß‡∏±‡∏ô<br/>‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</th>
                                        <th className="bg-yellow-50 text-yellow-900 border-l border-yellow-200 min-w-[60px] px-1">‡∏£‡∏ß‡∏°<br/>‡∏ö‡πà‡∏≤‡∏¢/‡∏î‡∏∂‡∏Å</th>
                                        <th className="bg-green-50 text-green-900 border-l border-green-200 min-w-[70px] px-1">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏£<br/>(‡∏ö/‡∏î)</th>
                                        <th className="bg-orange-50 text-orange-900 border-l-2 border-orange-200 min-w-[60px] px-1">‡∏£‡∏ß‡∏°<br/>OT</th>
                                        <th className="bg-orange-100 text-orange-900 border-l border-orange-200 min-w-[70px] px-1">‡∏Ñ‡πà‡∏≤ OT<br/>({config.otRate})</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {nurses.map((nurse, idx) => {
                                        const s = countStats(nurse.id);
                                        const isBalanced = s.workDays === config.workDayLimit;
                                        
                                        return (
                                            <React.Fragment key={nurse.id}>
                                                <tr className="border-b-0 hover:bg-gray-50">
                                                    <td rowSpan={2} className="sticky-1 font-bold text-gray-500 bg-white">{idx + 1}</td>
                                                    <td rowSpan={2} className="sticky-2 text-left px-2 bg-white">
                                                        {editingNurse?.id === nurse.id ? (
                                                            <div className="flex flex-col gap-1 z-50 relative">
                                                                <input autoFocus className="border rounded px-1 text-sm w-full" value={editingNurse.name} onChange={e => setEditingNurse({...editingNurse, name: e.target.value})} />
                                                                <div className="flex gap-1">
                                                                    <button onClick={handleSaveEdit} className="bg-green-500 text-white text-xs px-2 rounded">Save</button>
                                                                    <button onClick={() => setEditingNurse(null)} className="bg-gray-300 text-black text-xs px-2 rounded">Cancel</button>
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div className="flex justify-between items-center group">
                                                                <span className="truncate max-w-[100px]" title={nurse.name}>{nurse.name}</span>
                                                                <div className="hidden group-hover:flex gap-1">
                                                                    <Edit2 size={12} className="cursor-pointer text-blue-500" onClick={() => setEditingNurse(nurse)}/>
                                                                    <Trash2 size={12} className="cursor-pointer text-red-500" onClick={() => handleDeleteNurse(nurse.id)}/>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td rowSpan={2} className="sticky-3 font-semibold text-gray-600 bg-white">
                                                        {editingNurse?.id === nurse.id ? (
                                                            <select className="border rounded text-xs w-full" value={editingNurse.pos} onChange={e => setEditingNurse({...editingNurse, pos: e.target.value})}>
                                                                <option value="‡∏´‡∏ô‡∏ï.">‡∏´‡∏ô‡∏ï.</option><option value="L5">L5</option><option value="L4">L4</option><option value="L2">L2</option><option value="L1">L1</option>
                                                            </select>
                                                        ) : nurse.pos}
                                                    </td>
                                                    
                                                    {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                        const d = i + 1;
                                                        const val = schedule[getKey(nurse.id, 0, d)] || '0';
                                                        return (
                                                            <td key={`ot-${d}`} onClick={() => cycleShift(nurse.id, 0, d)} className={`cell-hover text-xs ${val !== '0' ? 'font-bold text-red-600 bg-red-50' : 'text-gray-200'}`}>
                                                                {val}
                                                            </td>
                                                        );
                                                    })}

                                                    <td rowSpan={2} className={`font-bold text-sm border-l-2 border-blue-200 ${isBalanced ? 'text-green-600 bg-green-50' : 'text-red-500 bg-white'}`}>
                                                        {s.workDays}
                                                        {!isBalanced && <div className="text-[9px] font-normal text-gray-400">{s.workDays - config.workDayLimit > 0 ? `+${s.workDays - config.workDayLimit}` : `${s.workDays - config.workDayLimit}`}</div>}
                                                    </td>
                                                    <td rowSpan={2} className="bg-yellow-50 font-semibold border-l border-yellow-200">{s.bdCount}</td>
                                                    <td rowSpan={2} className="bg-green-50 text-gray-600 text-xs border-l border-green-200">{s.bdPay > 0 ? s.bdPay.toLocaleString() : '-'}</td>
                                                    <td rowSpan={2} className="bg-orange-50 font-bold text-orange-700 border-l-2 border-orange-200">{s.otCount}</td>
                                                    <td rowSpan={2} className="bg-orange-100 text-orange-800 font-semibold text-xs border-l border-orange-200">{s.otPay > 0 ? s.otPay.toLocaleString() : '-'}</td>
                                                </tr>

                                                <tr className="border-b border-gray-300">
                                                    {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                                        const d = i + 1;
                                                        const val = schedule[getKey(nurse.id, 1, d)] || '0';
                                                        const style = SHIFT_METADATA[val] || SHIFT_METADATA['0'];
                                                        return (
                                                            <td key={`norm-${d}`} onClick={() => cycleShift(nurse.id, 1, d)} className={`cell-hover text-xs ${style.color}`}>
                                                                {val}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            </React.Fragment>
                                        );
                                    })}
                                </tbody>
                                <tfoot>
                                    <tr className="bg-gray-100 font-bold text-xs text-gray-600 border-t-2 border-gray-300">
                                        <td colSpan="3" className="sticky-1 text-right pr-2 bg-gray-100 z-40">‡∏£‡∏ß‡∏° ‡πÄ‡∏ä‡πâ‡∏≤</td>
                                        {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                            const c = countDailyTotal(i + 1, '‡∏ä');
                                            const target = config.shiftTargets['‡∏ä'] || 5;
                                            const statusColor = c < target ? 'text-red-600 bg-red-100' : (c > target ? 'text-blue-600 bg-blue-100' : 'text-green-700 bg-green-100');
                                            return <td key={i} className={statusColor}>{c || '-'}</td>;
                                        })}
                                        <td colSpan="5" className="bg-gray-200"></td>
                                    </tr>
                                    <tr className="bg-gray-100 font-bold text-xs text-gray-600">
                                        <td colSpan="3" className="sticky-1 text-right pr-2 bg-gray-100 z-40">‡∏£‡∏ß‡∏° ‡∏ö‡πà‡∏≤‡∏¢</td>
                                        {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                            const c = countDailyTotal(i + 1, '‡∏ö');
                                            const target = config.shiftTargets['‡∏ö'] || 3;
                                            const statusColor = c < target ? 'text-red-600 bg-red-100' : (c > target ? 'text-blue-600 bg-blue-100' : 'text-yellow-700 bg-yellow-100');
                                            return <td key={i} className={statusColor}>{c || '-'}</td>;
                                        })}
                                        <td colSpan="5" className="bg-gray-200"></td>
                                    </tr>
                                    <tr className="bg-gray-100 font-bold text-xs text-gray-600 border-b-2 border-gray-300">
                                        <td colSpan="3" className="sticky-1 text-right pr-2 bg-gray-100 z-40">‡∏£‡∏ß‡∏° ‡∏î‡∏∂‡∏Å</td>
                                        {Array.from({ length: getDaysInMonth() }, (_, i) => {
                                            const c = countDailyTotal(i + 1, '‡∏î');
                                            const target = config.shiftTargets['‡∏î'] || 2;
                                            const statusColor = c < target ? 'text-red-600 bg-red-100' : (c > target ? 'text-blue-600 bg-blue-100' : 'text-purple-700 bg-purple-100');
                                            return <td key={i} className={statusColor}>{c || '-'}</td>;
                                        })}
                                        <td colSpan="5" className="bg-gray-200"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    {/* Footer Legend */}
                    <div className="bg-white p-2 border-t border-gray-200 text-[11px] text-gray-600 flex justify-center gap-4 shrink-0 no-print">
                        <span className="font-bold">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå:</span>
                        <span className="px-2 py-0.5 rounded bg-green-100 text-green-800">‡∏ä (‡πÄ‡∏ä‡πâ‡∏≤)</span>
                        <span className="px-2 py-0.5 rounded bg-yellow-100 text-yellow-800">‡∏ö (‡∏ö‡πà‡∏≤‡∏¢) {config.shiftRates['‡∏ö']}‡∏ø</span>
                        <span className="px-2 py-0.5 rounded bg-purple-100 text-purple-800">‡∏î (‡∏î‡∏∂‡∏Å) {config.shiftRates['‡∏î']}‡∏ø</span>
                        <span className="px-2 py-0.5 rounded bg-red-50 text-red-600 font-bold border border-red-200">‡∏ï‡∏±‡∏ß‡πÅ‡∏î‡∏á‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô (OT) {config.otRate}‡∏ø</span>
                    </div>
                    <div className="text-center text-[10px] text-gray-400 font-medium pb-1">
                            ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏û‡∏ß.‡∏ß‡∏¥‡∏©‡∏ì‡∏∏‡∏Å‡∏£‡∏ì‡πå ‡πÇ‡∏≠‡∏¢‡∏≤ (‡∏£‡∏û.‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ)
                    </div>

                    {/* Show Settings Modal */}
                    {showSettingsModal && <SettingsModal />}

                    {/* Add Nurse Modal */}
                    {showAddNurseModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100]">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-80">
                                <h3 className="text-lg font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</h3>
                                <input className="w-full border p-2 mb-2 rounded" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" value={newNurse.name} onChange={e => setNewNurse({...newNurse, name: e.target.value})} />
                                <select className="w-full border p-2 mb-4 rounded" value={newNurse.pos} onChange={e => setNewNurse({...newNurse, pos: e.target.value})}>
                                    <option value="‡∏´‡∏ô‡∏ï.">‡∏´‡∏ô‡∏ï.</option><option value="L5">L5</option><option value="L4">L4</option><option value="L2">L2</option><option value="L1">L1</option>
                                </select>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowAddNurseModal(false)} className="px-4 py-2 bg-gray-200 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button onClick={handleAddNurse} className="px-4 py-2 bg-blue-600 text-white rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<RosterApp />);
    </script>
</body>
</html>
